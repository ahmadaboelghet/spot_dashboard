<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spot - ولي الأمر</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" href="./favicon.png">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: '#F2CE5A',
                        darkBg: '#050505', 
                        darkCard: '#121212',
                        darkBorder: '#262626',
                    },
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .glass-card {
            background: #121212;
            border: 1px solid #262626;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .glass-card:active { transform: scale(0.98); }

        .loader { border-top-color: #F2CE5A; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-darkBg text-gray-900 dark:text-white pb-32 min-h-screen">

    <div id="loadingScreen" class="fixed inset-0 z-[60] bg-darkBg flex items-center justify-center hidden">
        <div class="w-10 h-10 border-4 border-darkBorder rounded-full loader"></div>
    </div>

    <div class="fixed top-0 w-full bg-darkBg/90 backdrop-blur-md z-50 border-b border-darkBorder">
        <div class="flex justify-between items-center px-5 py-3 max-w-md mx-auto">
            <div class="flex items-center gap-3">
                <button id="backButton" onclick="showDashboard()" class="hidden text-gray-400 hover:text-white">
                    <i class="ri-arrow-right-line text-xl"></i>
                </button>

                <img src="assets/images/learnaria_logo.png" class="w-8 h-8 object-contain" onerror="this.src='assets/images/favicon.png'">
                <div>
                    <h1 class="text-2xl font-black tracking-tight leading-none text-white">
                        Spot<span class="text-brand text-3xl">.</span>
                    </h1>
                </div>
            </div>
            <button onclick="toggleTheme()" class="text-gray-400 hover:text-white">
                <i id="themeIcon" class="ri-sun-line text-xl"></i>
            </button>
        </div>
    </div>

    <main class="container mx-auto max-w-md px-5 pt-24 space-y-6">

        <div id="loginSection" class="hidden flex flex-col items-center justify-center pt-20">
            <div class="w-16 h-16 bg-brand/10 rounded-full flex items-center justify-center mb-4">
                <i class="ri-parent-line text-3xl text-brand"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">تسجيل دخول ولي الأمر</h2>
            <p class="text-gray-500 text-sm mb-6 text-center">أدخل رقم الهاتف المسجل لدى المدرسين لعرض كل المواد</p>
            
            <input type="tel" id="parentPhoneInput" placeholder="رقم الهاتف (01xxxxxxxxx)" 
                   class="w-full bg-darkCard border border-darkBorder rounded-xl p-4 text-center text-white mb-4 outline-none focus:border-brand">
            
            <button onclick="handleLogin()" class="w-full bg-brand text-black font-bold py-3 rounded-xl hover:bg-yellow-400 transition">
                عرض التقارير
            </button>
        </div>

        <div id="dashboardSection" class="hidden fade-in-up">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="ri-dashboard-line text-brand"></i> المواد المشتركة
            </h2>
            <div id="subjectsList" class="space-y-3">
                </div>
        </div>

        <div id="detailsSection" class="hidden fade-in-up">
            
            <div class="bg-darkCard border border-darkBorder rounded-2xl p-4 mb-6 flex justify-between items-center">
                <div>
                    <h2 id="detailStudentName" class="font-bold text-lg text-white">...</h2>
                    <p id="detailSubjectName" class="text-xs text-gray-400">...</p>
                </div>
                <div class="bg-brand/10 text-brand px-3 py-1 rounded-lg text-xs font-bold">نشط</div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card p-4 rounded-2xl text-center">
                    <p class="text-gray-400 text-xs font-bold mb-1">الحضور</p>
                    <h3 id="attendanceRate" class="text-2xl font-black text-white">--%</h3>
                </div>
                <div class="glass-card p-4 rounded-2xl text-center">
                    <p class="text-gray-400 text-xs font-bold mb-1">آخر درجة</p>
                    <h3 id="lastExamScore" class="text-2xl font-black text-brand">--</h3>
                </div>
            </div>

            <div class="flex bg-darkCard p-1 rounded-xl mb-6">
                <button onclick="switchInnerTab('home')" class="flex-1 py-2 text-xs font-bold rounded-lg bg-darkBorder text-white inner-tab" data-target="home">الرئيسية</button>
                <button onclick="switchInnerTab('attendance')" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:text-white inner-tab" data-target="attendance">الغياب</button>
                <button onclick="switchInnerTab('grades')" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:text-white inner-tab" data-target="grades">الدرجات</button>
            </div>

            <div id="content-home" class="inner-content space-y-4">
                <h3 class="font-bold text-white text-sm">النشاط الأخير</h3>
                <div id="timelineList" class="space-y-4 relative border-r border-darkBorder mr-2 pr-4"></div>
            </div>
            <div id="content-attendance" class="inner-content hidden space-y-3">
                <div id="attendanceList" class="space-y-2"></div>
            </div>
            <div id="content-grades" class="inner-content hidden space-y-3">
                <div id="gradesList" class="space-y-2"></div>
            </div>

            <div id="bigNotifyBanner" class="mt-8 bg-gradient-to-r from-red-900/20 to-red-600/20 border border-red-500/30 rounded-2xl p-4 flex items-center gap-4 cursor-pointer hidden" onclick="requestPermission()">
                <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white"><i class="ri-notification-3-fill"></i></div>
                <div>
                    <h4 class="font-bold text-sm text-white">تفعيل التنبيهات</h4>
                    <p class="text-xs text-gray-400">اضغط لتفعيل إشعارات هذا الطالب</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbN4awHvNUZWC-uCgU_hR7iYiHk-3dpv8",
            authDomain: "learnaria-483e7.firebaseapp.com",
            projectId: "learnaria-483e7",
            storageBucket: "learnaria-483e7.firebasestorage.app",
            messagingSenderId: "573038013067",
            appId: "1:573038013067:web:db6a78e8370d33b07a828e"
        };
        
        let db, messaging;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            if (firebase.messaging.isSupported()) messaging = firebase.messaging();
        } catch (e) { console.error("Firebase Init Error", e); }

        // --- 2. GLOBAL STATE ---
        let currentParentPhone = "";
        let currentContext = { tId: null, gId: null, sId: null };

        // --- 3. INIT LOGIC ---
        const urlParams = new URLSearchParams(window.location.search);
        // Check if we have specific student link OR just parent phone
        const urlPhone = urlParams.get('p');
        const urlTid = urlParams.get('t');

        if (urlTid && urlPhone) {
            // Direct Link Mode (Old behavior but integrated)
            currentParentPhone = urlPhone;
            loadStudentDetails(urlParams.get('t'), urlParams.get('g'), urlParams.get('s'), decodeURIComponent(urlParams.get('n') || ''));
        } else if (urlPhone) {
            // Dashboard Mode (via URL)
            currentParentPhone = urlPhone;
            loadDashboard();
        } else {
            // Login Mode
            document.getElementById('loginSection').classList.remove('hidden');
        }

        // --- 4. DASHBOARD FUNCTIONS ---
        function handleLogin() {
            const phone = document.getElementById('parentPhoneInput').value.trim();
            if (!phone || phone.length < 10) return alert("رقم الهاتف غير صحيح");
            currentParentPhone = phone;
            document.getElementById('loginSection').classList.add('hidden');
            loadDashboard();
        }

        async function loadDashboard() {
            showLoader(true);
            const list = document.getElementById('subjectsList');
            list.innerHTML = '';

            try {
                // Collection Group Query: Find ALL students with this parent phone
                // NOTE: Requires Firestore Index: students (Collection) -> parentPhoneNumber (Asc/Desc)
                const snapshot = await db.collectionGroup('students')
                                         .where('parentPhoneNumber', '==', currentParentPhone)
                                         .get();

                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="text-center py-10 text-gray-500">
                            <i class="ri-user-unfollow-line text-4xl mb-2"></i>
                            <p>لم يتم العثور على طلاب مسجلين بهذا الرقم.</p>
                            <p class="text-xs mt-2">تأكد من الرقم أو تواصل مع المدرس.</p>
                        </div>
                        <button onclick="location.reload()" class="w-full mt-4 bg-darkCard border border-darkBorder py-2 rounded-xl text-gray-400">جرب رقم تاني</button>
                    `;
                    showLoader(false);
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    return;
                }

                // Process each student found
                for (const doc of snapshot.docs) {
                    const studentData = doc.data();
                    // Extract IDs from path: teachers/{tId}/groups/{gId}/students/{sId}
                    const pathSegments = doc.ref.path.split('/');
                    const tId = pathSegments[1];
                    const gId = pathSegments[3];
                    const sId = doc.id;

                    // Get Teacher Name (Subject)
                    let teacherName = "مدرس";
                    let subjectName = "مادة";
                    try {
                        const teacherDoc = await db.collection('teachers').doc(tId).get();
                        if(teacherDoc.exists) {
                            teacherName = teacherDoc.data().name;
                            subjectName = teacherDoc.data().subject || "عام";
                        }
                    } catch(e) {}

                    // Render Card
                    const card = document.createElement('div');
                    card.className = "glass-card p-4 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-darkCard/50";
                    card.onclick = () => loadStudentDetails(tId, gId, sId, studentData.name, subjectName);
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-brand/10 text-brand flex items-center justify-center font-bold text-xl">
                                ${studentData.name.charAt(0)}
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg">${studentData.name}</h3>
                                <p class="text-sm text-gray-400">${subjectName} - ${teacherName}</p>
                            </div>
                        </div>
                        <i class="ri-arrow-left-s-line text-gray-500 text-xl"></i>
                    `;
                    list.appendChild(card);
                }

                document.getElementById('dashboardSection').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                if(error.code === 'failed-precondition') {
                    alert("النظام يحتاج تحديث (Index Required). يرجى إبلاغ الدعم الفني.");
                } else {
                    alert("حدث خطأ أثناء تحميل البيانات.");
                }
            } finally {
                showLoader(false);
            }
        }

        function showDashboard() {
            document.getElementById('detailsSection').classList.add('hidden');
            document.getElementById('backButton').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            // Reset context
            currentContext = { tId: null, gId: null, sId: null };
        }

        // --- 5. DETAILS FUNCTIONS (Logic ported from previous version) ---
        async function loadStudentDetails(tId, gId, sId, studentName, subjectName = "تفاصيل المادة") {
            currentContext = { tId, gId, sId };
            
            // UI Switch
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('detailsSection').classList.remove('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            
            // Set Header Info
            document.getElementById('detailStudentName').innerText = studentName;
            document.getElementById('detailSubjectName').innerText = subjectName;
            
            showLoader(true);

            try {
                // 1. Attendance
                const attRef = db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`)
                                 .orderBy('date', 'desc').limit(15);
                const attSnap = await attRef.get();
                
                let attHtml = '';
                let timelineHtml = '';
                let present = 0, total = 0;

                if (attSnap.empty) {
                    attHtml = `<p class="text-center text-gray-500 text-sm py-4">لا يوجد سجل حضور</p>`;
                } else {
                    attSnap.forEach(doc => {
                        const d = doc.data();
                        const record = d.records?.find(r => r.studentId === sId);
                        if (record) {
                            total++;
                            let color = 'text-gray-500 border-gray-700';
                            let icon = 'ri-question-mark';
                            let text = 'غير محدد';

                            if (record.status === 'present') {
                                present++;
                                color = 'text-green-500 border-green-500/30 bg-green-500/10';
                                icon = 'ri-check-line';
                                text = 'حاضر';
                            } else if (record.status === 'absent') {
                                color = 'text-red-500 border-red-500/30 bg-red-500/10';
                                icon = 'ri-close-line';
                                text = 'غائب';
                            } else if (record.status === 'late') {
                                present++;
                                color = 'text-orange-500 border-orange-500/30 bg-orange-500/10';
                                icon = 'ri-time-line';
                                text = 'تأخير';
                            }

                            // Timeline Item
                            timelineHtml += `
                                <div class="flex gap-4 relative pb-6 last:pb-0">
                                    <div class="absolute -right-[5px] top-1.5 w-2.5 h-2.5 rounded-full ${record.status === 'present' ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    <div class="w-full">
                                        <div class="flex justify-between items-center mb-1">
                                            <p class="text-xs font-bold text-gray-300">${d.date}</p>
                                            <span class="text-[10px] px-2 py-0.5 rounded ${color}">${text}</span>
                                        </div>
                                    </div>
                                </div>`;
                            
                            // List Item
                            attHtml += `
                                <div class="bg-darkCard p-3 rounded-xl flex justify-between items-center border border-darkBorder">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center ${color}">
                                            <i class="${icon}"></i>
                                        </div>
                                        <span class="text-sm font-bold text-gray-300">${d.date}</span>
                                    </div>
                                    <span class="text-xs font-bold text-gray-500">${text}</span>
                                </div>
                            `;
                        }
                    });
                }

                document.getElementById('attendanceList').innerHTML = attHtml;
                document.getElementById('timelineList').innerHTML = timelineHtml || '<p class="text-center text-gray-600 text-xs">لا يوجد نشاط حديث</p>';
                document.getElementById('attendanceRate').innerText = total > 0 ? Math.round((present / total) * 100) + '%' : '0%';

                // 2. Grades
                const gradesSnap = await db.collection(`teachers/${tId}/groups/${gId}/assignments`).limit(10).get();
                let gradesHtml = '';
                let lastScore = '-';

                if (gradesSnap.empty) {
                    gradesHtml = `<p class="text-center text-gray-500 text-sm py-4">لا توجد درجات</p>`;
                } else {
                    gradesSnap.forEach(doc => {
                        const d = doc.data();
                        const s = d.scores?.[sId];
                        if (s) {
                            lastScore = s.score || 0;
                            gradesHtml += `
                                <div class="bg-darkCard p-3 rounded-xl flex justify-between items-center border border-darkBorder">
                                    <div>
                                        <p class="text-sm font-bold text-white">${d.name}</p>
                                        <span class="text-[10px] text-gray-500 bg-black px-2 rounded">${d.type || 'واجب'}</span>
                                    </div>
                                    <div class="text-center">
                                        <span class="block text-lg font-black text-brand">${s.score}</span>
                                        <span class="text-[10px] text-gray-600">الدرجة</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                document.getElementById('gradesList').innerHTML = gradesHtml;
                document.getElementById('lastExamScore').innerText = lastScore;

                // Check Notifications Permission
                if (Notification.permission !== 'granted') {
                    document.getElementById('bigNotifyBanner').classList.remove('hidden');
                } else {
                    document.getElementById('bigNotifyBanner').classList.add('hidden');
                }

            } catch (e) {
                console.error(e);
            } finally {
                showLoader(false);
            }
        }

        // --- 6. HELPERS ---
        function switchInnerTab(tab) {
            document.querySelectorAll('.inner-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.inner-tab').forEach(el => {
                el.classList.remove('bg-darkBorder', 'text-white');
                el.classList.add('text-gray-500');
            });
            const activeBtn = document.querySelector(`.inner-tab[data-target="${tab}"]`);
            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.add('bg-darkBorder', 'text-white');
        }

        function showLoader(show) {
            const l = document.getElementById('loadingScreen');
            if (show) l.classList.remove('hidden');
            else l.classList.add('hidden');
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const icon = document.getElementById('themeIcon');
            if(document.documentElement.classList.contains('dark')) {
                icon.className = 'ri-sun-line text-xl';
            } else {
                icon.className = 'ri-moon-line text-xl';
            }
        }

        // --- 7. NOTIFICATIONS ---
        async function requestPermission() {
            if(!messaging) return alert("المتصفح لا يدعم التنبيهات");
            
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    const activeReg = await navigator.serviceWorker.ready;
                    const token = await messaging.getToken({ 
                        vapidKey: "BN3l770-6tQOnDww8FXClGklZcfNUHzSWFUBMR-NN8Qupvfz_rdiZ0duLit7LMZjwjbhJu1SzJyI21pACl1WOVE", 
                        serviceWorkerRegistration: activeReg 
                    });

                    if (token && currentContext.tId && currentContext.gId && currentContext.sId) {
                        // 1. Save token to Student Doc
                        await db.doc(`teachers/${currentContext.tId}/groups/${currentContext.gId}/students/${currentContext.sId}`)
                                .set({ parentFcmToken: token }, { merge: true });
                        
                        // 2. Save token to Parents Collection (General)
                        if(currentParentPhone) {
                            await db.collection('parents').doc(currentParentPhone)
                                    .set({ fcmToken: token }, { merge: true });
                        }

                        document.getElementById('bigNotifyBanner').classList.add('hidden');
                        alert("تم تفعيل الإشعارات بنجاح ✅");
                    }
                }
            } catch (e) {
                console.error(e);
                alert("حدث خطأ أثناء التفعيل");
            }
        }

        // Initial Theme
        document.documentElement.classList.add('dark');
    </script>
</body>
</html>