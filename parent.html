<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spot - Student Panel</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" href="./favicon.png">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: '#F2CE5A',
                        darkBg: '#020617', // Slate 950 (أشيك من الأسود الصريح)
                        darkCard: '#0f172a', // Slate 900
                        darkBorder: '#1e293b' // Slate 800
                    },
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #020617; color: white; }
        
        /* Modern Glass Effect */
        .glass-card {
            background: linear-gradient(145deg, #0f172a, #0b1120);
            border: 1px solid #1e293b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Floating Nav */
        .floating-nav {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid #1e293b;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.7);
        }

        .nav-item.active { color: #F2CE5A; background: rgba(242, 206, 90, 0.1); }
        .nav-item { color: #64748b; }

        .loader { border-top-color: #F2CE5A; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-32">

    <div id="loadingScreen" class="fixed inset-0 z-[60] bg-darkBg flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-darkBorder rounded-full loader"></div>
            <p class="text-sm text-gray-500 font-bold">جاري تحميل البيانات...</p>
        </div>
    </div>

    <div id="errorScreen" class="hidden fixed inset-0 z-[55] bg-darkBg flex items-center justify-center p-6 text-center">
        <div class="max-w-xs">
            <i class="ri-link-unlink-m text-6xl text-red-500 mb-4 block"></i>
            <h2 class="text-xl font-bold mb-2">رابط غير صالح</h2>
            <p class="text-gray-400 text-sm">الرابط لا يحتوي على بيانات الطالب. يرجى طلب الرابط الصحيح من المدرس.</p>
        </div>
    </div>

    <div class="fixed top-0 w-full bg-darkBg/80 backdrop-blur-xl z-50 border-b border-darkBorder">
        <div class="flex justify-between items-center px-5 py-4 max-w-md mx-auto">
            <div class="flex items-center gap-3">
                <img src="assets/images/learnaria_logo.png" class="w-9 h-9 object-contain" onerror="this.src='assets/images/favicon.png'">
                <div>
                    <h1 class="text-2xl font-black tracking-tight leading-none">
                        Spot<span class="text-brand text-3xl">.</span>
                    </h1>
                </div>
                <div class="h-8 w-[1px] bg-darkBorder mx-2"></div>
                <div>
                    <h1 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Student Panel</h1>
                    <h2 id="studentNameDisplay" class="text-sm font-bold text-gray-200 leading-none truncate max-w-[120px]">...</h2>
                </div>
            </div>
        </div>
    </div>

    <main class="container mx-auto max-w-md px-5 pt-28 space-y-6 min-h-screen">
        
        <div id="bigNotifyBanner" class="hidden relative group cursor-pointer" onclick="handlePermissionClick()">
            <div class="absolute -inset-0.5 bg-gradient-to-r from-red-600 to-brand rounded-2xl blur opacity-30 group-hover:opacity-60 transition"></div>
            <div class="relative bg-darkCard border border-darkBorder rounded-2xl p-5 flex items-center gap-4">
                <div class="w-12 h-12 bg-red-500/10 rounded-xl flex items-center justify-center text-red-500 animate-pulse">
                    <i class="ri-notification-3-fill text-2xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-white">تفعيل التنبيهات</h3>
                    <p class="text-xs text-gray-400">اضغط لاستلام الإشعارات</p>
                </div>
                <i class="ri-arrow-left-s-line text-gray-500"></i>
            </div>
        </div>

        <div id="successBanner" class="hidden bg-green-500/10 border border-green-500/20 rounded-2xl p-4 flex items-center gap-3">
            <i class="ri-checkbox-circle-fill text-green-500 text-xl"></i>
            <p class="text-xs font-bold text-green-400">الإشعارات مفعلة بنجاح</p>
        </div>

        <div id="content-home" class="tab-content space-y-5 fade-in-up">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="ri-calendar-check-fill text-6xl text-white"></i></div>
                    <p class="text-gray-400 text-xs font-bold mb-1">نسبة الحضور</p>
                    <h3 id="attendanceRate" class="text-3xl font-black text-white">--%</h3>
                </div>
                <div class="glass-card p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="ri-medal-fill text-6xl text-brand"></i></div>
                    <p class="text-gray-400 text-xs font-bold mb-1">آخر درجة</p>
                    <h3 id="lastExamScore" class="text-3xl font-black text-brand">--</h3>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-white text-base mb-4 flex items-center gap-2">
                    <i class="ri-history-line text-brand"></i> النشاط الأخير
                </h3>
                <div id="timelineList" class="space-y-4"></div>
            </div>
        </div>

        <div id="content-attendance" class="tab-content hidden space-y-4 fade-in-up">
            <div id="attendanceList" class="space-y-3"></div>
        </div>

        <div id="content-grades" class="tab-content hidden space-y-4 fade-in-up">
            <div id="gradesList" class="space-y-3"></div>
        </div>

        <div id="content-schedule" class="tab-content hidden space-y-4 fade-in-up">
            <div id="scheduleList" class="space-y-3"></div>
        </div>
    </main>

    <div class="fixed bottom-8 left-0 right-0 z-50 px-6 pointer-events-none">
        <nav class="floating-nav max-w-xs mx-auto rounded-full p-2 pointer-events-auto flex justify-between items-center">
            <button onclick="switchTab('home')" class="nav-item active flex-1 h-12 rounded-full flex items-center justify-center transition-all" data-target="home"><i class="ri-home-5-fill text-xl"></i></button>
            <button onclick="switchTab('attendance')" class="nav-item flex-1 h-12 rounded-full flex items-center justify-center transition-all" data-target="attendance"><i class="ri-calendar-check-fill text-xl"></i></button>
            <button onclick="switchTab('grades')" class="nav-item flex-1 h-12 rounded-full flex items-center justify-center transition-all" data-target="grades"><i class="ri-medal-fill text-xl"></i></button>
            <button onclick="switchTab('schedule')" class="nav-item flex-1 h-12 rounded-full flex items-center justify-center transition-all" data-target="schedule"><i class="ri-time-fill text-xl"></i></button>
        </nav>
    </div>

    <script>
        // --- 1. CONFIG & SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbN4awHvNUZWC-uCgU_hR7iYiHk-3dpv8",
            authDomain: "learnaria-483e7.firebaseapp.com",
            projectId: "learnaria-483e7",
            storageBucket: "learnaria-483e7.firebasestorage.app",
            messagingSenderId: "573038013067",
            appId: "1:573038013067:web:db6a78e8370d33b07a828e"
        };
        
        let db, messaging;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            if (firebase.messaging.isSupported()) messaging = firebase.messaging();
        } catch (e) { console.error("Firebase Init Error:", e); }

        // --- 2. URL PARSING (CRITICAL) ---
        const urlParams = new URLSearchParams(window.location.search);
        // التعامل مع المسافات في الـ ID
        let tId = urlParams.get('t') ? urlParams.get('t').replace(/ /g, '+') : null;
        const gId = urlParams.get('g'); 
        const sId = urlParams.get('s'); 
        const urlName = urlParams.get('n');
        const pNum = urlParams.get('p');

        // Check if params exist
        if (!tId || !gId || !sId) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            throw new Error("Missing Parameters");
        }

        if(urlName) document.getElementById('studentNameDisplay').innerText = decodeURIComponent(urlName);

        // --- 3. UI FUNCTIONS ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-target="${tabId}"]`).classList.add('active');
        }

        function renderEmptyState(message) {
            return `
            <div class="flex flex-col items-center justify-center py-10 text-gray-600">
                <i class="ri-inbox-2-line text-4xl mb-2 opacity-50"></i>
                <p class="text-xs font-medium">${message}</p>
            </div>`;
        }

        // --- 4. DATA LOADING ---
        async function loadData() {
            try {
                // A. Attendance
                const attRef = db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`)
                                 .orderBy('date', 'desc').limit(20);
                
                attRef.get().then(snap => {
                    let html = '', timeline = '', present = 0, total = 0;
                    
                    if(snap.empty) {
                        html = renderEmptyState("لا يوجد سجل حضور");
                        timeline = renderEmptyState("لا يوجد نشاط حديث");
                    } else {
                        snap.forEach(doc => {
                            const d = doc.data();
                            const rec = d.records?.find(r => r.studentId === sId);
                            if(rec) {
                                total++;
                                let color = 'text-gray-400 bg-gray-800';
                                let text = 'غير محدد';
                                let icon = 'ri-question-mark';

                                if(rec.status === 'present') { present++; color='text-green-400 bg-green-500/10 border-green-500/20'; text='حاضر'; icon='ri-check-line'; }
                                else if(rec.status === 'absent') { color='text-red-400 bg-red-500/10 border-red-500/20'; text='غائب'; icon='ri-close-line'; }
                                else if(rec.status === 'late') { present++; color='text-orange-400 bg-orange-500/10 border-orange-500/20'; text='تأخير'; icon='ri-time-line'; }

                                // List Item
                                html += `
                                <div class="glass-card p-4 rounded-xl flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center border ${color.split(' ')[2]} ${color.split(' ')[1]} ${color.split(' ')[0]}">
                                            <i class="${icon} text-lg"></i>
                                        </div>
                                        <div><p class="font-bold text-sm text-gray-200">${d.date}</p></div>
                                    </div>
                                    <span class="text-[10px] font-bold px-3 py-1 rounded-full border ${color.split(' ')[2]} ${color.split(' ')[1]} ${color.split(' ')[0]}">${text}</span>
                                </div>`;

                                // Timeline Item
                                if(timeline.length < 1000) { // Limit items
                                    timeline += `
                                    <div class="flex gap-4 relative pb-6 last:pb-0 border-r border-darkBorder pr-4 mr-2">
                                        <div class="absolute -right-[5px] top-1 w-2.5 h-2.5 rounded-full ${rec.status==='present'?'bg-green-500':(rec.status==='absent'?'bg-red-500':'bg-orange-500')}"></div>
                                        <div>
                                            <p class="text-xs font-bold text-gray-300">حصة يوم ${d.date}</p>
                                            <p class="text-[10px] text-gray-500 mt-1">تم تسجيل الحالة: <span class="${color.split(' ')[0]}">${text}</span></p>
                                        </div>
                                    </div>`;
                                }
                            }
                        });
                    }

                    document.getElementById('attendanceList').innerHTML = html || renderEmptyState("لم يتم تسجيل حضور للطالب بعد");
                    document.getElementById('timelineList').innerHTML = timeline || renderEmptyState("لا يوجد نشاط حديث");
                    document.getElementById('attendanceRate').innerText = total > 0 ? Math.round((present/total)*100)+'%' : '0%';
                });

                // B. Grades
                db.collection(`teachers/${tId}/groups/${gId}/assignments`).limit(10).get().then(snap => {
                    let html = '', lastScore = '-';
                    if(snap.empty) html = renderEmptyState("لا توجد واجبات أو امتحانات");
                    else {
                        snap.forEach(doc => {
                            const d = doc.data();
                            const s = d.scores?.[sId];
                            if(s) {
                                lastScore = s.score || 0;
                                html += `
                                <div class="glass-card p-4 rounded-xl flex justify-between items-center">
                                    <div>
                                        <h4 class="font-bold text-sm text-gray-200">${d.name}</h4>
                                        <span class="text-[10px] text-gray-500 bg-darkBg px-2 py-1 rounded mt-1 inline-block border border-darkBorder">${d.type||'واجب'}</span>
                                    </div>
                                    <div class="text-center">
                                        <span class="block text-xl font-black text-brand">${lastScore}</span>
                                        <span class="text-[10px] text-gray-600">الدرجة</span>
                                    </div>
                                </div>`;
                            }
                        });
                    }
                    document.getElementById('gradesList').innerHTML = html || renderEmptyState("لا توجد درجات مسجلة");
                    document.getElementById('lastExamScore').innerText = lastScore;
                });

                // C. Schedule
                db.collection(`teachers/${tId}/groups/${gId}/recurringSchedules`).get().then(snap => {
                    let html = '';
                    const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                    if(snap.empty) html = renderEmptyState("لم يتم تحديد جدول");
                    else {
                        snap.forEach(doc => {
                            const d = doc.data();
                            html += `
                            <div class="glass-card p-4 rounded-xl border-r-4 border-brand flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-sm text-white mb-1">${d.subject}</h4>
                                    <div class="text-xs text-gray-500 flex items-center gap-1">
                                        <i class="ri-calendar-line"></i> ${d.days.map(x=>days[x]).join('، ')}
                                    </div>
                                </div>
                                <span class="bg-brand text-black px-3 py-1 rounded-lg font-bold text-xs shadow-lg shadow-brand/20">${d.time}</span>
                            </div>`;
                        });
                    }
                    document.getElementById('scheduleList').innerHTML = html;
                });

            } catch(e) { 
                console.error(e); 
            } finally {
                // Hide Loader
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('opacity-0');
                    setTimeout(()=>document.getElementById('loadingScreen').classList.add('hidden'), 500);
                }, 1000);
            }
        }

        // --- 5. PERMISSIONS ---
        function handlePermissionClick() {
            if(!messaging) return alert("غير مدعوم على هذا المتصفح");
            requestPermission();
        }

        async function requestPermission() {
            const btn = document.getElementById('bigNotifyBanner');
            btn.style.opacity = '0.5';
            try {
                const perm = await Notification.requestPermission();
                if(perm === 'granted') {
                    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    const activeReg = await navigator.serviceWorker.ready; // Fix timing
                    const token = await messaging.getToken({ vapidKey: "BN3l770-6tQOnDww8FXClGklZcfNUHzSWFUBMR-NN8Qupvfz_rdiZ0duLit7LMZjwjbhJu1SzJyI21pACl1WOVE", serviceWorkerRegistration: activeReg });
                    
                    if(token && tId && gId && sId) {
                        await db.doc(`teachers/${tId}/groups/${gId}/students/${sId}`).set({ parentFcmToken: token }, { merge: true });
                        if(pNum) await db.collection('parents').doc(pNum).set({ fcmToken: token }, { merge: true });
                        
                        btn.classList.add('hidden');
                        document.getElementById('successBanner').classList.remove('hidden');
                        new Notification("تم بنجاح ✅", { body: "تم تفعيل الإشعارات.", icon: './favicon.png' });
                    }
                } else { alert("تم رفض الإذن"); }
            } catch(e) { alert("خطأ: " + e.message); } 
            finally { btn.style.opacity = '1'; }
        }

        if(Notification.permission !== 'granted') document.getElementById('bigNotifyBanner').classList.remove('hidden');

        // Start
        loadData();
    </script>
</body>
</html>