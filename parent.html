<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark-mode">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spot</title>

    <link rel="icon" href="assets/images/favicon.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="assets/images/learnaria_logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F2CE5A">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Inter:wght@400;600;700;800&family=Readex+Pro:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: ['class', '.dark-mode'],
            theme: {
                extend: {
                    colors: {
                        primary: '#F2CE5A',
                        brand: '#F2CE5A',
                        darkBg: '#121212',
                        darkCard: '#1E1E1E',
                        lightBg: '#F9FAFB',
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                        readex: ['Readex Pro', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(242, 206, 90, 0.15)',
                    },
                    animation: {
                        'fade-up': 'fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s infinite ease-in-out'
                    },
                    keyframes: {
                        fadeUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Readex Pro', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .bg-grid-pattern {
            background-color: #F9FAFB;
            background-image:
                linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 16px 16px;
        }

        .dark-mode .bg-grid-pattern {
            background-color: #121212;
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        }

        .spot-card {
            border-radius: 20px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
        }

        .dark-mode .spot-card {
            background-color: #1E1E1E !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #FFFFFF !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .spot-card h3,
        .dark-mode .spot-card p.text-lg,
        .dark-mode .spot-card span.font-bold,
        .dark-mode .text-gray-900 {
            color: #FFFFFF !important;
        }

        .dark-mode .spot-card p.text-gray-500,
        .dark-mode .spot-card .text-gray-400,
        .dark-mode .text-gray-500 {
            color: #9CA3AF !important;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .dark-mode .glass-header {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .tab-container {
            background-color: #F3F4F6;
            border-radius: 16px;
            padding: 4px;
        }

        .dark-mode .tab-container {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tab-btn {
            transition: all 0.3s;
            color: #6B7280;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .dark-mode .tab-btn {
            color: #9CA3AF;
        }

        .tab-btn.active {
            background-color: #F2CE5A !important;
            color: #000000 !important;
            font-weight: 800 !important;
            box-shadow: 0 4px 12px rgba(242, 206, 90, 0.3);
        }

        .input-field {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            color: #111827;
        }

        .dark-mode .input-field {
            background: #1E1E1E;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #FFFFFF;
        }

        .input-field:focus {
            border-color: #F2CE5A;
            box-shadow: 0 0 0 2px rgba(242, 206, 90, 0.2);
        }

        .loader {
            border-top-color: #F2CE5A;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-grid-pattern text-gray-900 dark:text-white min-h-screen transition-colors duration-300 pb-10">

    <div id="loadingScreen"
        class="fixed inset-0 z-[100] bg-lightBg dark:bg-darkBg flex flex-col items-center justify-center hidden">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-gray-200 dark:border-gray-800 border-t-primary rounded-full loader">
            </div>
            <div class="absolute inset-0 flex items-center justify-center animate-pulse">
                <img src="assets/images/favicon.png" class="w-10 h-10 object-contain"
                    onerror="this.src='assets/images/favicon.png'">
            </div>
        </div>
    </div>

    <header class="fixed top-4 left-4 right-4 z-50 glass-header rounded-2xl transition-all duration-300">
        <div class="px-5 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="relative w-11 h-11 rounded-xl bg-white border-2 border-primary flex items-center justify-center shadow-sm">
                    <img src="assets/images/favicon.png" class="w-7 h-7 object-contain"
                        onerror="this.src='assets/images/favicon.png'">
                    <div
                        class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-green-500 rounded-full border-[3px] border-white dark:border-[#1E1E1E]">
                    </div>
                </div>
                <div>
                    <h1
                        class="text-3xl font-black text-gray-900 dark:text-white font-inter tracking-tighter leading-none mt-1">
                        Spot<span class="text-primary text-4xl">.</span>
                    </h1>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleDarkMode()"
                    class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-white/5 flex items-center justify-center transition text-gray-600 dark:text-gray-300 hover:text-primary">
                    <i id="themeIcon" class="ri-moon-line text-lg"></i>
                </button>
                <button onclick="logout()"
                    class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-500/10 text-red-500 flex items-center justify-center transition hover:bg-red-100">
                    <i class="ri-logout-box-r-line text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-5 pt-32 max-w-lg">

        <div id="loginSection" class="hidden min-h-[60vh] flex flex-col items-center justify-center animate-fade-up">
            <div
                class="w-24 h-24 bg-white dark:bg-darkCard rounded-[2rem] shadow-glow flex items-center justify-center mb-8 border-2 border-gray-100 dark:border-white/5 relative">
                <div
                    class="absolute -right-2 -bottom-2 w-6 h-6 bg-green-500 rounded-full border-4 border-white dark:border-darkBg z-10">
                </div>
                <img src="assets/images/favicon.png" class="w-14 h-14 object-contain"
                    onerror="this.src='assets/images/favicon.png'">
            </div>
            <h2 class="text-3xl font-black mb-2 text-center text-gray-900 dark:text-white font-inter">Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
            </h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-10 text-center px-6 leading-relaxed font-medium">
                Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
            </p>
            <div class="w-full space-y-4">
                <div class="relative group">
                    <input type="tel" id="parentPhoneInput" placeholder="01xxxxxxxxx"
                        class="w-full input-field rounded-2xl p-4 text-center text-xl font-bold outline-none transition-all font-mono">
                    <i
                        class="ri-smartphone-line absolute top-1/2 -translate-y-1/2 right-5 text-gray-400 text-xl group-focus-within:text-primary transition-colors"></i>
                </div>
                <button onclick="handleLogin()"
                    class="w-full bg-primary hover:bg-yellow-400 text-black font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all text-lg flex items-center justify-center gap-2">
                    <span>Ø¯Ø®ÙˆÙ„</span><i class="ri-arrow-left-line"></i>
                </button>
            </div>
        </div>

        <div id="dashboardSection" class="hidden space-y-8 animate-fade-up">
            <div class="flex justify-between items-end px-1 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 tracking-wide">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                    <h2 id="headerGuardianText"
                        class="text-2xl font-black leading-tight text-gray-900 dark:text-white font-cairo">...</h2>
                </div>
            </div>
            <button type="button" onclick="requestPermission()" id="notifyBanner"
                class="hidden w-full text-right cursor-pointer relative overflow-hidden rounded-[2rem] border border-primary/30 bg-primary/5 p-6 flex items-center gap-5 transition-all duration-200 active:scale-95 hover:shadow-md z-20 group">

                <div
                    class="absolute inset-0 bg-gradient-to-r from-primary/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                </div>

                <div
                    class="w-14 h-14 bg-primary text-black rounded-full flex items-center justify-center shadow-glow animate-pulse shrink-0 border-4 border-white dark:border-darkCard z-10">
                    <i class="ri-notification-3-fill text-2xl"></i>
                </div>

                <div class="flex-1 z-10">
                    <h3 class="font-black text-xl text-gray-900 dark:text-white font-cairo mb-1">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
                    <p class="text-sm font-bold text-gray-500 dark:text-gray-400">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª
                        ÙÙˆØ±Ø§Ù‹</p>
                </div>
            </button>
            <div>
                <h3
                    class="font-bold text-lg mb-5 flex items-center gap-2 px-1 text-gray-900 dark:text-white font-cairo">
                    <i class="ri-dashboard-fill text-primary"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
                </h3>
                <div id="coursesList" class="space-y-5"></div>
            </div>
        </div>

        <div id="detailsModal"
            class="fixed inset-0 z-[60] pointer-events-none opacity-0 transition-opacity duration-300 flex items-end sm:items-center justify-center">

            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" id="modalBackdrop"></div>

            <div id="modalContainer"
                class="relative w-full max-w-lg h-[85vh] bg-lightBg dark:bg-darkBg rounded-t-[2.5rem] transform translate-y-full transition-transform duration-300 pointer-events-auto flex flex-col shadow-2xl overflow-hidden border-t border-white/10">

                <div
                    class="px-6 py-6 bg-white dark:bg-darkCard border-b border-gray-100 dark:border-white/5 z-10 sticky top-0">
                    <div class="w-12 h-1.5 bg-gray-200 dark:bg-white/10 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class="text-[10px] font-bold bg-primary/10 text-primary px-2 py-0.5 rounded-lg border border-primary/20">Ø§Ù„Ù…Ø§Ø¯Ø©</span>
                            </div>
                            <h2 id="modalSubject"
                                class="text-2xl font-black text-gray-900 dark:text-white leading-none font-cairo">...
                            </h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 font-bold">Ù…Ø¹Ù„Ù…: <span
                                    id="modalTeacher" class="text-primary">...</span></p>
                        </div>

                        <button type="button" id="closeDetailsBtn"
                            class="relative z-50 w-10 h-10 bg-gray-100 dark:bg-white/10 rounded-full flex items-center justify-center text-gray-500 hover:text-red-500 dark:hover:bg-red-500/20 transition-colors cursor-pointer shadow-md">
                            <i class="ri-close-line text-xl pointer-events-none"></i>
                        </button>
                    </div>

                    <div class="tab-container flex mt-6 gap-1">
                        <button onclick="switchTab('home')" class="tab-btn active flex-1 py-3 text-xs rounded-xl"
                            id="btn-home">Ù…Ù„Ø®Øµ</button>
                        <button onclick="switchTab('homework')" class="tab-btn flex-1 py-3 text-xs rounded-xl"
                            id="btn-homework">Ø§Ù„ÙˆØ§Ø¬Ø¨</button>
                        <button onclick="switchTab('grades')" class="tab-btn flex-1 py-3 text-xs rounded-xl"
                            id="btn-grades">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
                        <button onclick="switchTab('payments')" class="tab-btn flex-1 py-3 text-xs rounded-xl"
                            id="btn-payments">Ù…ØµØ§Ø±ÙŠÙ</button>
                        <button onclick="switchTab('notifications')" class="tab-btn flex-1 py-3 text-xs rounded-xl"
                            id="btn-notifications">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-transparent custom-scroll">

                    <div id="view-home" class="tab-content space-y-6 animate-fade-up">
                        <div id="todayScheduleContainer"
                            class="hidden spot-card p-4 flex items-center justify-between border-r-4 border-primary bg-primary/5">
                            <div>
                                <p class="text-xs font-bold text-gray-500 dark:text-gray-400"><i
                                        class="ri-calendar-event-fill text-primary"></i> Ù…ÙˆØ¹Ø¯ Ø§Ù„ÙŠÙˆÙ…</p>
                                <h3 id="todayClassTime" class="text-xl font-black text-gray-900 dark:text-white mt-1">
                                    --:--</h3>
                            </div>
                            <span class="bg-primary text-black text-[10px] font-bold px-3 py-1 rounded-lg">Ø¯Ø±Ø³
                                Ø§Ù„ÙŠÙˆÙ…</span>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="spot-card p-5 text-center">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                                <h3 id="modalAttPerc" class="text-3xl font-black text-gray-900 dark:text-white">--%</h3>
                            </div>
                            <div class="spot-card p-5 text-center">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold mb-2">Ø¢Ø®Ø± Ø§Ù…ØªØ­Ø§Ù†</p>
                                <h3 id="modalLastGrade" class="text-3xl font-black text-primary">--</h3>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-gray-400 mb-4 flex items-center gap-2"><i
                                    class="ri-history-line text-primary"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                            <div id="modalAttendanceList"
                                class="space-y-0 relative border-r-2 border-gray-200 dark:border-white/5 mr-2 pr-5 pb-2">
                            </div>
                        </div>
                    </div>

                    <div id="view-homework" class="tab-content hidden space-y-4 animate-fade-up">
                        <div id="modalHomeworkList" class="space-y-3"></div>
                    </div>

                    <div id="view-grades" class="tab-content hidden space-y-4 animate-fade-up">
                        <div id="modalGradesList" class="space-y-3"></div>
                    </div>

                    <div id="view-payments" class="tab-content hidden space-y-5 animate-fade-up">
                        <div id="paymentStatusBanner"
                            class="spot-card p-6 flex items-center justify-between border-r-4">
                            <div>
                                <p class="text-sm font-bold text-gray-900 dark:text-white">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="currentMonthName">...</p>
                            </div>
                            <span id="currentMonthStatus" class="px-4 py-2 rounded-xl text-xs font-bold">--</span>
                        </div>
                        <h3 class="text-xs font-bold text-gray-400 mt-6 mb-3 flex items-center gap-2"><i
                                class="ri-wallet-3-fill text-primary"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                        <div id="modalPaymentsList" class="space-y-3"></div>
                    </div>

                    <div id="view-notifications" class="tab-content hidden space-y-4 animate-fade-up">
                        <div id="modalNotificationsList" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbN4awHvNUZWC-uCgU_hR7iYiHk-3dpv8",
            authDomain: "learnaria-483e7.firebaseapp.com",
            projectId: "learnaria-483e7",
            storageBucket: "learnaria-483e7.firebasestorage.app",
            messagingSenderId: "573038013067",
            appId: "1:573038013067:web:db6a78e8370d33b07a828e"
        };

        let db, messaging;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            if (firebase.messaging.isSupported()) messaging = firebase.messaging();
        } catch (e) { console.error(e); }

        let currentParentPhone = "";
        let unsubscribeStudents = null;

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage))) {
            document.documentElement.classList.add('dark-mode');
            document.getElementById('themeIcon').className = 'ri-sun-line text-lg';
        } else {
            document.documentElement.classList.remove('dark-mode');
            document.getElementById('themeIcon').className = 'ri-moon-line text-lg';
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('closeDetailsBtn').addEventListener('click', closeDetails);
            document.getElementById('modalBackdrop').addEventListener('click', closeDetails);
            setupPhoneInput('parentPhoneInput'); // ØªØ£ÙƒØ¯ Ø¥Ù† Ø¯Ù‡ Ø§Ù„Ù€ ID Ø§Ù„ØµØ­ ÙÙŠ ØµÙØ­Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
        });

        const urlParams = new URLSearchParams(window.location.search);
        const urlP = urlParams.get('p');

        if (urlP) {
            currentParentPhone = urlP;
            loadAppRealtime();
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
        }

        function handleLogin() {
            const phone = document.getElementById('parentPhoneInput').value.trim();
            if (phone.length < 10) return alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
            currentParentPhone = phone;
            document.getElementById('loginSection').classList.add('hidden');
            loadAppRealtime();
        }

        /**
 * Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ù‡ÙŠØ² Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ:
 * - ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.
 * - Ù…Ù†Ø¹ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø±Ù…ÙˆØ².
 * - ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙˆÙ„ Ø¨Ù€ 11 Ø±Ù‚Ù….
 * - Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ù€ 01.
 */
        function setupPhoneInput(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            input.addEventListener('input', function (e) {
                let val = this.value;

                // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù -Ù©) Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (0-9)
                const arabicMap = { 'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4', 'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9' };
                val = val.replace(/[Ù -Ù©]/g, match => arabicMap[match]);

                // 2. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø­Ø°Ù Ø£ÙŠ Ø­Ø±ÙˆÙ Ø£Ùˆ Ø±Ù…ÙˆØ²)
                val = val.replace(/\D/g, '');

                // 3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ "01" (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ùˆ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØºÙ„Ø·)
                // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ¨ Ø±Ù‚Ù… ÙˆÙ…Ø³Ø­ØŒ Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø£ÙˆÙ„ Ø±Ù‚Ù…ÙŠÙ† Ù‡Ù…Ø§ 01 Ù„Ùˆ Ø§Ù„Ø·ÙˆÙ„ ÙŠØ³Ù…Ø­
                if (val.length >= 2) {
                    if (!val.startsWith('01')) {
                        // Ù„Ùˆ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØºÙ„Ø·ØŒ Ù…Ù…ÙƒÙ† Ù†Ù…Ø³Ø­Ù‡Ø§ Ø£Ùˆ Ù†Ø³ÙŠØ¨Ù‡Ø§ Ù„Ù„ÙŠÙˆØ²Ø± ÙŠØµØ­Ø­Ù‡Ø§ØŒ 
                        // Ø¨Ø³ Ø§Ù„Ø£ÙØ¶Ù„ Ù†Ø³ÙŠØ¨Ù‡Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†Ø¶Ø§ÙŠÙ‚ÙˆØ´ ÙˆÙ‡Ùˆ Ø¨ÙŠÙƒØªØ¨ØŒ ÙˆØ§Ù„Ù€ Validation Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‡Ùˆ Ø§Ù„Ø­ÙƒÙ….
                        // Ù„ÙƒÙ† Ø¹Ø´Ø§Ù† Ø·Ù„Ø¨Ùƒ "ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01"ØŒ Ù…Ù…ÙƒÙ† Ù†Ø®Ù„ÙŠÙ‡ Ù…Ø§ ÙŠÙƒÙ…Ù„Ø´ ÙƒØªØ§Ø¨Ø© Ù„Ùˆ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø´ 01
                        // val = '01'; // (Ø¯Ù‡ Ø­Ù„ Ø¹Ù†ÙŠÙ Ø´ÙˆÙŠØ©)
                    }
                }

                // 4. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 11 Ø±Ù‚Ù…
                if (val.length > 11) {
                    val = val.slice(0, 11);
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
                this.value = val;
            });

            // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© maxlength ÙÙŠ Ø§Ù„Ù€ HTML ÙƒØ§Ø­ØªÙŠØ§Ø·
            input.setAttribute("maxLength", "11");
            input.setAttribute("inputmode", "numeric"); // ÙŠÙØªØ­ ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        }

        function logout() {
            if (unsubscribeStudents) unsubscribeStudents();
            window.location.href = window.location.pathname;
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark-mode')) {
                html.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeIcon').className = 'ri-moon-line text-lg';
            } else {
                html.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeIcon').className = 'ri-sun-line text-lg';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tab}`).classList.add('active');
        }

        function loadAppRealtime() {
            document.getElementById('loadingScreen').classList.remove('hidden');

            // âœ… Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµØ­ÙŠØ­: onSnapshot Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ
            unsubscribeStudents = db.collectionGroup('students')
                .where('parentPhoneNumber', '==', currentParentPhone)
                .onSnapshot(async (snapshot) => {
                    if (snapshot.empty) {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        // Ù„Ø§ Ù†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø­ØªÙˆÙ‰ Ø³Ø§Ø¨Ù‚Ø§Ù‹ (ØªØ¬Ù†Ø¨ Ø§Ù„ÙˆÙ…ÙŠØ¶)
                        if (!document.getElementById('coursesList').hasChildNodes()) {
                            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª");
                            document.getElementById('loginSection').classList.remove('hidden');
                        }
                        return;
                    }

                    document.getElementById('dashboardSection').classList.remove('hidden');
                    const coursesContainer = document.getElementById('coursesList');
                    coursesContainer.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

                    let studentNames = new Set();

                    const renderPromises = snapshot.docs.map(async (doc) => {
                        const sData = doc.data();
                        studentNames.add(sData.name.split(' ')[0]);
                        const path = doc.ref.path.split('/');
                        const studentObj = {
                            sId: doc.id,
                            tId: path[1],
                            gId: path[3],
                            name: sData.name
                        };
                        return await createStudentCardHTML(studentObj);
                    });

                    const cardsHTML = await Promise.all(renderPromises);
                    coursesContainer.innerHTML = cardsHTML.join('');

                    if (studentNames.size > 0) document.getElementById('headerGuardianText').innerHTML = `ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="text-primary">${Array.from(studentNames).join('ØŒ ')}</span>`;

                    if (Notification.permission !== 'granted') document.getElementById('notifyBanner').classList.remove('hidden');
                    else document.getElementById('notifyBanner').classList.add('hidden');

                    document.getElementById('loadingScreen').classList.add('hidden');

                }, (error) => {
                    console.error("Error fetching data:", error);
                    document.getElementById('loadingScreen').classList.add('hidden');
                });
        }

        // ==========================================
        // ğŸ iOS Smart Install Prompt (Black Edition)
        // ==========================================

        function detectAndPromptIOS() {
            const userAgent = window.navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

            if (isIOS && !isInStandaloneMode) {
                setTimeout(showIOSPrompt, 1000);
            }
        }

        function showIOSPrompt() {
            const existing = document.querySelector('.ios-prompt-overlay');
            if (existing) existing.remove();

            const style = document.createElement('style');
            style.innerHTML = `
        .ios-prompt-overlay {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid rgba(200,200,200,0.4);
            z-index: 10000; font-family: -apple-system, sans-serif;
            direction: rtl; text-align: right;
            animation: slideUpIOS 0.6s ease-out;
        }
        .ios-header {
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .ios-title { font-weight: 700; font-size: 16px; color: #000; }
        .ios-close { font-size: 20px; color: #888; background: none; border: none; cursor: pointer;}
        .ios-close:hover { color: #000; }
        .ios-body { padding: 15px 20px; }
        .ios-step { display: flex; align-items: center; margin-bottom: 12px; font-size: 13px; color: #333; font-weight: 500;}
        .ios-step:last-child { margin-bottom: 0; }
        
        /* ØªÙ… ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø£Ø³ÙˆØ¯ */
        .step-num { font-weight: bold; color: #000000; margin-left: 8px; min-width: 15px;}
        .step-icon { width: 22px; height: 22px; margin-right: auto; display: block;}
        
        .ios-arrow-down {
            position: absolute; bottom: -12px; 
            right: 20px; 
            width: 0; height: 0; 
            border-left: 12px solid transparent; border-right: 12px solid transparent;
            border-top: 12px solid rgba(255, 255, 255, 0.95);
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
            animation: bounceArrow 2s infinite;
        }
        @keyframes slideUpIOS { from { bottom: -200px; opacity: 0; } to { bottom: 80px; opacity: 1; } }
        @keyframes bounceArrow { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-8px);} }
    `;
            document.head.appendChild(style);

            // ØªÙ… ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù€ stroke ÙÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ù† #007aff Ø¥Ù„Ù‰ #000000
            const dotsIcon = `<svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>`;
            const shareIcon = `<svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>`;
            const plusIcon = `<svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="4" ry="4"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`;

            const promptDiv = document.createElement('div');
            promptDiv.className = 'ios-prompt-overlay';
            promptDiv.innerHTML = `
        <div class="ios-header">
            <span class="ios-title">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“²</span>
            <button class="ios-close" onclick="this.closest('.ios-prompt-overlay').remove()">âœ•</button>
        </div>
        <div class="ios-body">
            <div class="ios-step">
                <span class="step-num">1.</span>
                Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·)
                ${dotsIcon}
            </div>
            <div class="ios-step">
                <span class="step-num">2.</span>
                Ø§Ø®ØªØ± "Ù…Ø´Ø§Ø±ÙƒØ©" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                ${shareIcon}
            </div>
            <div class="ios-step">
                <span class="step-num">3.</span>
                Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
                ${plusIcon}
            </div>
             <div style="text-align:center; font-size:10px; color:#999; margin-top:8px;">Add to Home Screen</div>
        </div>
        <div class="ios-arrow-down"></div>
    `;

            document.body.appendChild(promptDiv);
        }

        window.addEventListener('load', detectAndPromptIOS);

        async function createStudentCardHTML(student) {
            // âœ… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ø¹Ù† Ø­Ø§Ù„Ø© Ø¯ÙØ¹ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            const date = new Date();
            const currentMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

            const payQueryPromise = db.collection(`teachers/${student.tId}/groups/${student.gId}/payments`)
                .where('month', '==', currentMonth)
                .limit(1)
                .get();

            const [tDoc, attSnap, assSnap, payQuerySnap] = await Promise.all([
                db.collection('teachers').doc(student.tId).get(),
                db.collection(`teachers/${student.tId}/groups/${student.gId}/dailyAttendance`).limit(30).get(),
                db.collection(`teachers/${student.tId}/groups/${student.gId}/assignments`).limit(15).get(),
                payQueryPromise
            ]);

            let tName = "Ù…Ø¯Ø±Ø³", subName = "Ù…Ø§Ø¯Ø©";
            if (tDoc.exists) { tName = tDoc.data().name; subName = tDoc.data().subject || "Ø¹Ø§Ù…"; }

            let totalDays = 0, presentDays = 0;
            attSnap.forEach(d => {
                const r = d.data().records?.find(x => x.studentId === student.sId);
                if (r) { totalDays++; if (r.status === 'present') presentDays++; }
            });
            const attPerc = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;

            // âœ… Ù…Ù†Ø·Ù‚ Ø¢Ø®Ø± Ø§Ù…ØªØ­Ø§Ù† (Ù„ÙŠØ³ ÙˆØ§Ø¬Ø¨)
            let lastGrade = '--';
            if (!assSnap.empty) {
                for (const doc of assSnap.docs) {
                    const d = doc.data();
                    const sc = d.scores?.[student.sId];
                    const name = d.name || "";
                    const type = d.type || "";

                    // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª (Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹)
                    const isHomework = type === 'daily' || name.match(/^Homework/i) || name.match(/^ÙˆØ§Ø¬Ø¨/i);

                    if (!isHomework && sc && sc.score !== null && sc.score !== undefined && sc.score !== "") {
                        lastGrade = sc.score;
                        break;
                    }
                }
            }

            // âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ù€ Query
            let isPaid = false;
            if (!payQuerySnap.empty) {
                const payDoc = payQuerySnap.docs[0];
                const r = payDoc.data().records?.find(x => x.studentId === student.sId);
                if (r && r.paid) isPaid = true;
            }

            return `
            <div class="spot-card p-5 cursor-pointer group relative overflow-hidden" onclick="openDetails('${student.tId}', '${student.gId}', '${student.sId}', '${tName}', '${subName}')">
                <div class="absolute -right-5 -top-5 w-24 h-24 bg-primary/5 rounded-full blur-xl group-hover:bg-primary/10 transition"></div>
                <div class="flex justify-between items-start mb-5 relative z-10">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-gray-50 dark:bg-black border border-gray-200 dark:border-white/5 flex items-center justify-center shadow-inner">
                            <span class="text-xl font-black text-primary">${subName.charAt(0)}</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-black font-cairo leading-tight text-gray-900 dark:text-white">${subName}</h3>
                            <p class="text-[10px] text-gray-500 font-bold">${tName}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-[10px] bg-gray-100 dark:bg-white/5 text-gray-500 dark:text-gray-300 px-2 py-0.5 rounded-md font-bold">${student.name.split(' ')[0]}</span>
                        ${isPaid ? '<span class="text-[10px] text-green-500 bg-green-500/10 px-2 py-0.5 rounded-md font-bold border border-green-500/20">Ù…Ø¯ÙÙˆØ¹</span>' : '<span class="text-[10px] text-red-500 bg-red-500/10 px-2 py-0.5 rounded-md font-bold border border-red-500/20">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>'}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2 border-t border-gray-100 dark:border-white/5 pt-3">
                    <div><p class="text-[10px] text-gray-400 font-bold">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</p><p class="text-lg font-black ${attPerc > 85 ? 'text-green-500' : 'text-primary'}">${attPerc}%</p></div>
                    <div><p class="text-[10px] text-gray-400 font-bold">Ø¢Ø®Ø± Ø§Ù…ØªØ­Ø§Ù†</p><p class="text-lg font-black text-gray-900 dark:text-white">${lastGrade}</p></div>
                </div>
            </div>`;
        }

        async function openDetails(tId, gId, sId, tName, subject) {
            document.getElementById('modalSubject').innerText = subject;
            document.getElementById('modalTeacher').innerText = tName;
            const modal = document.getElementById('detailsModal');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            cont.classList.remove('translate-y-full');
            document.getElementById('modalBackdrop').classList.remove('hidden');

            switchTab('home');
            loadDetailsData(tId, gId, sId);
        }

        async function loadDetailsData(tId, gId, sId) {
            const attList = document.getElementById('modalAttendanceList');
            const grList = document.getElementById('modalGradesList');
            const hwList = document.getElementById('modalHomeworkList');
            const payList = document.getElementById('modalPaymentsList');
            const notifList = document.getElementById('modalNotificationsList');

            attList.innerHTML = '<div class="loader w-6 h-6 border-2 border-gray-500 border-t-primary rounded-full mx-auto my-2"></div>';
            grList.innerHTML = ''; hwList.innerHTML = ''; payList.innerHTML = ''; notifList.innerHTML = '';
            document.getElementById('todayScheduleContainer').classList.add('hidden');

            try {
                const [attSnap, assSnap, paySnap, schedSnap, notifSnap] = await Promise.all([
                    db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`).get(),
                    db.collection(`teachers/${tId}/groups/${gId}/assignments`).get(),
                    db.collection(`teachers/${tId}/groups/${gId}/payments`).get(),
                    db.collection(`teachers/${tId}/groups/${gId}/recurringSchedules`).get(),
                    db.collection(`teachers/${tId}/groups/${gId}/students/${sId}/notificationHistory`).get()
                ]);

                // 1. Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const todayIndex = new Date().getDay();
                let todayClass = null;
                schedSnap.forEach(doc => {
                    const s = doc.data();
                    if (s.days && s.days.includes(todayIndex)) todayClass = s.time;
                });
                if (todayClass) {
                    document.getElementById('todayScheduleContainer').classList.remove('hidden');
                    const [h, m] = todayClass.split(':');
                    const hour = parseInt(h);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const h12 = hour % 12 || 12;
                    document.getElementById('todayClassTime').innerText = `${h12}:${m} ${ampm}`;
                }

                // 2. Ø§Ù„Ø­Ø¶ÙˆØ± (Sorting in-memory)
                let attHtml = '', total = 0, present = 0;
                const sortedAtt = attSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(d => d.date)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 20);

                sortedAtt.forEach(d => {
                    const r = d.records?.find(x => x.studentId === sId);
                    if (r) {
                        total++; if (r.status === 'present') present++;
                        let col = r.status === 'present' ? 'bg-green-500' : (r.status === 'absent' ? 'bg-red-500' : 'bg-yellow-500');
                        let txt = r.status === 'present' ? 'Ø­Ø§Ø¶Ø±' : (r.status === 'absent' ? 'ØºØ§Ø¦Ø¨' : 'ØªØ£Ø®ÙŠØ±');
                        let txtCol = r.status === 'present' ? 'text-green-500' : (r.status === 'absent' ? 'text-red-500' : 'text-yellow-500');
                        attHtml += `<div class="relative pl-6 pb-8 last:pb-0 border-l-2 border-gray-200 dark:border-white/10 last:border-0"><div class="absolute -right-[7px] top-0 w-3.5 h-3.5 rounded-full ${col} ring-4 ring-white dark:ring-darkBg z-10"></div><div class="flex justify-between items-center bg-white dark:bg-white/5 p-3 rounded-xl border border-gray-100 dark:border-white/5"><span class="text-sm font-bold text-gray-800 dark:text-gray-200">${d.date}</span><span class="text-xs font-bold px-2 py-0.5 rounded bg-black/5 dark:bg-white/10 ${txtCol}">${txt}</span></div></div>`;
                    }
                });
                document.getElementById('modalAttendanceList').innerHTML = attHtml || '<p class="text-center text-gray-500 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</p>';
                document.getElementById('modalAttPerc').innerText = total > 0 ? Math.round((present / total) * 100) + '%' : '0%';

                // 3. Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ÙØµÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø¹Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¨Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù†ÙˆØ¹ (Sorting in-memory)
                let gradesHtml = '', homeworkHtml = '', lastG = '--';
                const sortedAss = assSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(d => d.date)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 30);

                sortedAss.forEach(d => {
                    const s = d.scores?.[sId];
                    const name = d.name || "";
                    const type = d.type || "";

                    if (s) {
                        // Ù‡Ù„ Ù‡Ùˆ ÙˆØ§Ø¬Ø¨ØŸ (Ù†ÙˆØ¹ daily Ø£Ùˆ Ø§Ø³Ù…Ù‡ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ Homework/ÙˆØ§Ø¬Ø¨)
                        const isHomework = type === 'daily' || name.match(/^Homework/i) || name.match(/^ÙˆØ§Ø¬Ø¨/i);

                        if (isHomework) {
                            const isSubmitted = s.submitted;
                            homeworkHtml += `
                        <div class="spot-card p-4 flex justify-between items-center border-r-4 ${isSubmitted ? 'border-green-500' : 'border-red-500'}">
                            <div><h4 class="font-bold text-sm text-gray-900 dark:text-white">${name}</h4><span class="text-[10px] text-gray-400">${d.date}</span></div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold ${isSubmitted ? 'text-green-500' : 'text-red-500'}">${isSubmitted ? 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' : 'Ù„Ù… ÙŠØªÙ…'}</span>
                                <div class="w-8 h-8 rounded-full ${isSubmitted ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} flex items-center justify-center"><i class="${isSubmitted ? 'ri-check-line' : 'ri-close-line'}"></i></div>
                            </div>
                        </div>`;
                        }
                        // Ø¥Ø°Ø§Ù‹ Ù‡Ùˆ Ø§Ù…ØªØ­Ø§Ù† (Ø­ØªÙ‰ Ù„Ùˆ Ø¯Ø±Ø¬ØªÙ‡ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø¹Ø±Ø¶Ù‡)
                        else {
                            const displayScore = (s.score !== null && s.score !== undefined && s.score !== "") ? s.score : 'ØºØ§Ø¦Ø¨';
                            if (lastG === '--' && displayScore !== 'ØºØ§Ø¦Ø¨') lastG = displayScore;

                            gradesHtml += `
                        <div class="spot-card p-4 flex justify-between items-center border-l-4 border-primary">
                            <div><h4 class="font-bold text-sm text-gray-900 dark:text-white">${name}</h4><span class="text-[10px] text-gray-400">${d.date}</span></div>
                            <div class="text-center"><span class="block text-xl font-black text-gray-900 dark:text-white">${displayScore}</span><span class="text-[9px] text-gray-400">Ø§Ù„Ø¯Ø±Ø¬Ø©</span></div>
                        </div>`;
                        }
                    }
                });
                document.getElementById('modalGradesList').innerHTML = gradesHtml || '<p class="text-center text-gray-500 text-xs py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</p>';
                document.getElementById('modalHomeworkList').innerHTML = homeworkHtml || '<p class="text-center text-gray-500 text-xs py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª</p>';
                document.getElementById('modalLastGrade').innerText = lastG;

                // 4. Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
                let payHtml = '';
                const currM = new Date().toISOString().slice(0, 7);
                let currSt = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', currCls = 'bg-red-500 text-white';

                paySnap.forEach(d => {
                    const m = d.data().month;
                    const r = d.data().records?.find(x => x.studentId === sId);
                    const p = r && r.paid;

                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if (m === currM) {
                        if (p) { currSt = 'ØªÙ… Ø§Ù„Ø¯ÙØ¹'; currCls = 'bg-green-500 text-white'; }
                        else { currSt = 'Ù…Ø·Ù„ÙˆØ¨ Ø³Ø¯Ø§Ø¯'; currCls = 'bg-red-500 text-white'; }
                        document.getElementById('currentMonthStatus').innerText = currSt;
                        document.getElementById('currentMonthStatus').className = `px-3 py-1 rounded-lg text-xs font-bold ${currCls}`;
                    }

                    payHtml += `<div class="flex justify-between p-3 rounded-xl bg-gray-50 dark:bg-white/5 mb-2"><span class="font-bold text-sm text-gray-800 dark:text-gray-200">${m}</span><span class="text-xs font-bold ${p ? 'text-green-500' : 'text-red-500'}">${p ? (r.amount + ' Ø¬.Ù…') : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}</span></div>`;
                });
                document.getElementById('modalPaymentsList').innerHTML = payHtml;
                document.getElementById('paymentStatusBanner').className = `spot-card p-6 flex items-center justify-between border-r-4 ${currSt.includes('Ø§Ù„Ø¯ÙØ¹') ? 'border-green-500' : 'border-red-500'}`;

                // 5. Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Sorting in-memory)
                let notifHtml = '';
                const sortedNotifs = notifSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.sentAt?.seconds || 0) - (a.sentAt?.seconds || 0))
                    .slice(0, 20);

                sortedNotifs.forEach(d => {
                    const n = d; // d is already the data object due to map
                    const iconMap = {
                        'notifyOnPresence': 'ri-checkbox-circle-fill text-green-500',
                        'AutoAbsence': 'ri-error-warning-fill text-red-500',
                        'ManualAbsence': 'ri-error-warning-fill text-red-500',
                        'notifyOnNewGrades': 'ri-edit-2-fill text-primary',
                        'notifyOnPayment': 'ri-money-dollar-circle-fill text-green-500',
                        'paymentReminder': 'ri-alarm-warning-fill text-yellow-500',
                        'classReminder': 'ri-time-fill text-primary',
                        'sendCustomMessage': 'ri-chat-3-fill text-primary'
                    };
                    const icon = iconMap[n.context] || 'ri-notification-3-fill text-gray-500';
                    const time = n.sentAt ? formatNotifDate(new Date(n.sentAt.seconds * 1000)) : '...';

                    notifHtml += `
                <div class="spot-card p-4 flex gap-4 items-start bg-white dark:bg-white/5 border border-gray-100 dark:border-white/5">
                    <div class="w-10 h-10 rounded-full bg-gray-50 dark:bg-black/20 flex items-center justify-center shrink-0">
                        <i class="${icon} text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-sm text-gray-900 dark:text-white">${n.title}</h4>
                            <span class="text-[9px] text-gray-400 font-medium">${time}</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">${n.body}</p>
                    </div>
                </div>`;
                });
                document.getElementById('modalNotificationsList').innerHTML = notifHtml || '<p class="text-center text-gray-500 text-xs py-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>';
            } catch (error) {
                console.error("Error loading details:", error);
                attList.innerHTML = '<p class="text-center text-red-500 text-xs py-4">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.</p>';
            }
        }

        function formatNotifDate(date) {
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });

            if (isToday) return `Ø§Ù„ÙŠÙˆÙ… ${timeStr}`;
            return `${date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' })} ${timeStr}`;
        }

        function closeDetails() {
            document.getElementById('modalContainer').classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('detailsModal').classList.add('opacity-0', 'pointer-events-none');
            }, 300);
        }

        // âœ… Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
        async function requestPermission() {
            // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­
            if (!('Notification' in window)) {
                return alert("Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.");
            }

            if (!messaging) {
                return alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Firebase Messaging).");
            }

            const banner = document.getElementById('notifyBanner');
            const originalText = banner.innerHTML;
            banner.innerHTML = '<div class="loader w-5 h-5 border-2 border-black border-t-transparent rounded-full mx-auto"></div>';

            try {
                // 2. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    // 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚Ù‡ Ù…Ø¹ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
                    // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù firebase-messaging-sw.js Ø¨Ø¬ÙˆØ§Ø± parent.html
                    let reg;
                    try {
                        reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    } catch (swError) {
                        alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Service Worker: " + swError.message);
                        throw swError;
                    }

                    // 4. Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†
                    const token = await messaging.getToken({
                        vapidKey: "BN3l770-6tQOnDww8FXClGklZcfNUHzSWFUBMR-NN8Qupvfz_rdiZ0duLit7LMZjwjbhJu1SzJyI21pACl1WOVE",
                        serviceWorkerRegistration: reg
                    });

                    if (token) {
                        // 5. Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
                        // Ø­ÙØ¸ Ù„Ù„Ø£Ø¨
                        await db.collection('parents').doc(currentParentPhone).set({ fcmToken: token }, { merge: true });

                        // Ø­ÙØ¸ Ù„Ù„Ø·Ù„Ø§Ø¨
                        const snapshot = await db.collectionGroup('students').where('parentPhoneNumber', '==', currentParentPhone).get();
                        if (!snapshot.empty) {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.update(doc.ref, { parentFcmToken: token });
                            });
                            await batch.commit();
                        }

                        document.getElementById('notifyBanner').classList.add('hidden');
                        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                    } else {
                        alert("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ†. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                        banner.innerHTML = originalText;
                    }
                } else {
                    alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.");
                    banner.innerHTML = originalText;
                }
            } catch (error) {
                console.error("Permission Error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message); // Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
                banner.innerHTML = originalText;
            }
        }
    </script>
</body>

</html>