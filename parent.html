<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Learnaria - متابعة الطالب</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" href="./favicon.png">
    <meta name="theme-color" content="#F5F5F5">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // مطابقة لألوان ملف app_styles.dart
                        brand: '#E5AD35',       // primaryYello
                        primaryBlack: '#212121', // primaryBlack
                        bgLight: '#F5F5F5',      // lightGrey
                        textGrey: '#616161',     // darkGrey
                        iconGrey: '#AAA9A2',     // mediumGrey
                        success: '#4CAF50'       // greenSuccess
                    },
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] },
                    boxShadow: {
                        'card': '0 2px 10px rgba(0, 0, 0, 0.05)',
                        'nav': '0 -2px 10px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #F5F5F5; -webkit-tap-highlight-color: transparent; }
        
        .app-card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        .app-card:active { transform: scale(0.98); }

        .loader { border-top-color: #E5AD35; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-primaryBlack pb-24">

    <div id="loadingScreen" class="fixed inset-0 z-[60] bg-bgLight flex items-center justify-center hidden">
        <div class="flex flex-col items-center gap-3">
            <div class="w-10 h-10 border-4 border-gray-200 rounded-full loader"></div>
            <p class="text-sm font-bold text-gray-400">جاري التحميل...</p>
        </div>
    </div>

    <div id="loginSection" class="hidden min-h-screen flex flex-col items-center justify-center px-6">
        <div class="w-24 h-24 bg-white rounded-3xl shadow-card flex items-center justify-center mb-6">
            <img src="assets/images/learnaria_logo.png" class="w-16 h-16 object-contain">
        </div>
        <h2 class="text-2xl font-bold mb-2">تسجيل دخول ولي الأمر</h2>
        <p class="text-textGrey text-sm mb-8 text-center">أدخل رقم الهاتف المسجل لعرض لوحة الطالب</p>
        
        <div class="w-full relative mb-4">
            <i class="ri-smartphone-line absolute top-4 right-4 text-iconGrey text-xl"></i>
            <input type="tel" id="parentPhoneInput" placeholder="01xxxxxxxxx" 
                   class="w-full bg-white border-none rounded-xl p-4 pr-12 text-primaryBlack shadow-sm outline-none focus:ring-2 focus:ring-brand/50 font-bold tracking-wider">
        </div>
        
        <button onclick="handleLogin()" class="w-full bg-primaryBlack text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transition active:scale-95">
            دخول
        </button>
    </div>

    <div id="appScaffold" class="hidden">
        
        <div class="fixed top-0 w-full bg-white z-50 px-4 py-3 shadow-sm flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="assets/images/learnaria_logo.png" class="w-8 h-8">
                <h1 class="text-xl font-bold text-primaryBlack">Learnaria</h1>
            </div>
            <button class="w-10 h-10 rounded-full hover:bg-gray-50 flex items-center justify-center">
                <i class="ri-settings-4-line text-xl text-textGrey"></i>
            </button>
        </div>

        <main class="container mx-auto max-w-md px-4 pt-20 space-y-6">

            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-14 h-14 rounded-full bg-brand flex items-center justify-center text-white text-2xl font-bold border-2 border-white shadow-md">
                        <i class="ri-user-smile-line"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-primaryBlack leading-tight">مرحباً، <span id="studentNameDisplay">...</span></h2>
                        <p id="currentDateDisplay" class="text-xs text-textGrey font-medium mt-1">...</p>
                    </div>
                </div>
                <div onclick="requestPermission()" class="w-10 h-10 rounded-full bg-white border border-gray-100 shadow-sm flex items-center justify-center relative cursor-pointer active:scale-95">
                    <i class="ri-notification-3-line text-xl text-primaryBlack"></i>
                    <div id="notifyDot" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold text-primaryBlack mb-3">التقارير</h3>
                <div class="flex gap-4">
                    <div class="app-card flex-1 p-4 flex flex-col justify-between h-32 relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <span class="text-sm font-bold text-primaryBlack">الواجبات</span>
                            <i class="ri-file-list-3-line text-brand text-xl"></i>
                        </div>
                        <div>
                            <h4 id="assignmentsCount" class="text-2xl font-black text-brand">--</h4>
                            <p id="assignmentsStatus" class="text-[10px] text-brand font-bold opacity-80">...</p>
                        </div>
                    </div>

                    <div class="app-card flex-1 p-4 flex flex-col justify-between h-32 relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <span class="text-sm font-bold text-primaryBlack">الحضور</span>
                            <i class="ri-calendar-check-line text-success text-xl"></i>
                        </div>
                        <div>
                            <h4 id="attendancePercent" class="text-2xl font-black text-success">--%</h4>
                            <p id="attendanceText" class="text-[10px] text-success font-bold opacity-80">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold text-primaryBlack mb-3">جدول اليوم</h3>
                <div id="todaysCoursesList" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2">
                    <div class="min-w-[140px] h-24 bg-white rounded-2xl border border-gray-100 flex items-center justify-center text-textGrey text-xs">
                        لا توجد حصص اليوم
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold text-primaryBlack mb-3">المعلمون</h3>
                <div id="teachersList" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2">
                    </div>
            </div>

            <div id="detailsModal" class="fixed inset-0 z-[100] bg-white transform translate-y-full transition-transform duration-300 flex flex-col">
                <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-white shadow-sm">
                    <div>
                        <h2 id="modalTitle" class="font-bold text-lg text-primaryBlack">التفاصيل</h2>
                        <p id="modalSubtitle" class="text-xs text-textGrey">...</p>
                    </div>
                    <button onclick="closeDetails()" class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center text-primaryBlack">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-5 bg-bgLight space-y-4">
                    <div id="modalContent" class="space-y-3"></div>
                </div>
            </div>

        </main>

        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 pb-safe pt-2 px-6 flex justify-between items-center shadow-nav z-40">
            <button class="flex flex-col items-center gap-1 p-2 text-brand">
                <i class="ri-home-5-fill text-2xl"></i>
                <span class="text-[10px] font-bold">الرئيسية</span>
            </button>
            <button class="flex flex-col items-center gap-1 p-2 text-iconGrey hover:text-primaryBlack transition">
                <i class="ri-bar-chart-box-line text-2xl"></i>
                <span class="text-[10px] font-medium">التقدم</span>
            </button>
            <button class="flex flex-col items-center gap-1 p-2 text-iconGrey hover:text-primaryBlack transition">
                <i class="ri-mail-line text-2xl"></i>
                <span class="text-[10px] font-medium">الرسائل</span>
            </button>
            <button class="flex flex-col items-center gap-1 p-2 text-iconGrey hover:text-primaryBlack transition">
                <i class="ri-user-3-line text-2xl"></i>
                <span class="text-[10px] font-medium">الملف</span>
            </button>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbN4awHvNUZWC-uCgU_hR7iYiHk-3dpv8",
            authDomain: "learnaria-483e7.firebaseapp.com",
            projectId: "learnaria-483e7",
            storageBucket: "learnaria-483e7.firebasestorage.app",
            messagingSenderId: "573038013067",
            appId: "1:573038013067:web:db6a78e8370d33b07a828e"
        };
        
        let db, messaging;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            if (firebase.messaging.isSupported()) messaging = firebase.messaging();
        } catch (e) { console.error("Firebase Init Error", e); }

        let currentParentPhone = "";
        let dashboardData = { reports: [] };

        // --- INIT ---
        const urlParams = new URLSearchParams(window.location.search);
        const urlPhone = urlParams.get('p');

        // Set Date
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
        document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('ar-EG', dateOptions);

        if (urlPhone) {
            currentParentPhone = urlPhone;
            loadApp();
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
        }

        // --- APP LOGIC ---
        function handleLogin() {
            const phone = document.getElementById('parentPhoneInput').value.trim();
            if (!phone || phone.length < 10) return alert("رقم الهاتف غير صحيح");
            currentParentPhone = phone;
            document.getElementById('loginSection').classList.add('hidden');
            loadApp();
        }

        async function loadApp() {
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            try {
                // 1. Fetch Students
                const snapshot = await db.collectionGroup('students')
                                         .where('parentPhoneNumber', '==', currentParentPhone)
                                         .get();

                if (snapshot.empty) {
                    alert("لم يتم العثور على طلاب مسجلين بهذا الرقم");
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('loginSection').classList.remove('hidden');
                    return;
                }

                document.getElementById('appScaffold').classList.remove('hidden');
                
                // 2. Fetch Data Aggregation
                let totalAssignments = 0;
                let submittedAssignments = 0;
                let presentDays = 0;
                let totalAttendanceDays = 0;
                let scheduleList = [];
                let teachersList = [];

                // Name Greeting
                const firstStudent = snapshot.docs[0].data();
                document.getElementById('studentNameDisplay').innerText = firstStudent.name.split(' ')[0];

                for (const doc of snapshot.docs) {
                    const sData = doc.data();
                    const pathSegments = doc.ref.path.split('/'); 
                    const tId = pathSegments[1];
                    const gId = pathSegments[3];
                    const sId = doc.id;

                    // Get Teacher/Subject
                    let teacherName = "مدرس";
                    let subject = "مادة";
                    const tDoc = await db.collection('teachers').doc(tId).get();
                    if(tDoc.exists) {
                        teacherName = tDoc.data().name;
                        subject = tDoc.data().subject || "عام";
                    }

                    // Add to Teachers List
                    teachersList.push({ name: teacherName, subject, id: tId, sId, gId });

                    // Stats: Attendance
                    const attSnap = await db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`).limit(20).get();
                    attSnap.forEach(d => {
                        const rec = d.data().records?.find(r => r.studentId === sId);
                        if(rec) {
                            totalAttendanceDays++;
                            if(rec.status === 'present') presentDays++;
                        }
                    });

                    // Stats: Grades
                    const assSnap = await db.collection(`teachers/${tId}/groups/${gId}/assignments`).limit(20).get();
                    assSnap.forEach(d => {
                        const score = d.data().scores?.[sId];
                        totalAssignments++;
                        if(score && (score.submitted === true || score.score)) submittedAssignments++;
                    });

                    // Schedule
                    const schedSnap = await db.collection(`teachers/${tId}/groups/${gId}/recurringSchedules`).get();
                    schedSnap.forEach(d => {
                        const sch = d.data();
                        const todayIndex = new Date().getDay(); 
                        if(sch.days && sch.days.includes(todayIndex)) {
                            scheduleList.push({
                                subject: subject,
                                time: sch.time,
                                teacher: teacherName,
                                tId, gId, sId // For click navigation
                            });
                        }
                    });
                }

                // 3. Update Stats UI
                document.getElementById('assignmentsCount').innerText = totalAssignments > 0 ? `${submittedAssignments}/${totalAssignments}` : '-';
                document.getElementById('assignmentsStatus').innerText = totalAssignments > 0 ? (submittedAssignments === totalAssignments ? 'مكتمل' : 'مطلوب تسليم') : 'لا يوجد';
                
                const attPercent = totalAttendanceDays > 0 ? Math.round((presentDays / totalAttendanceDays) * 100) : 0;
                document.getElementById('attendancePercent').innerText = `${attPercent}%`;
                document.getElementById('attendanceText').innerText = attPercent > 85 ? 'حضور ممتاز' : (attPercent > 60 ? 'جيد' : 'يحتاج تحسين');

                // 4. Render Lists
                renderTeachers(teachersList);
                renderSchedule(scheduleList);

                // Check Notifications
                if(Notification.permission !== 'granted') document.getElementById('notifyDot').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                // Handle Index Error specifically
                if(e.code === 'failed-precondition') alert("النظام يحتاج لتهيئة (Index). راجع الـ Console");
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        }

        function renderTeachers(list) {
            const container = document.getElementById('teachersList');
            container.innerHTML = '';
            list.forEach(t => {
                const div = document.createElement('div');
                div.className = "min-w-[130px] bg-white rounded-2xl shadow-card overflow-hidden cursor-pointer active:scale-95 transition";
                div.onclick = () => openDetails(t.id, t.gId, t.sId, t.name, t.subject);
                
                // Avatar
                const avatarUrl = `https://avatar.iran.liara.run/username?username=${t.name.replace(' ','+')}`;
                
                div.innerHTML = `
                    <div class="h-24 bg-gray-50">
                        <img src="${avatarUrl}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <h4 class="text-sm font-bold text-primaryBlack truncate">${t.name}</h4>
                        <p class="text-[10px] text-textGrey truncate">${t.subject}</p>
                        <div class="mt-2 flex justify-end">
                            <div class="w-6 h-6 bg-gray-100 rounded-lg flex items-center justify-center text-textGrey">
                                <i class="ri-chat-3-line text-xs"></i>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderSchedule(list) {
            const container = document.getElementById('todaysCoursesList');
            container.innerHTML = '';
            if(list.length === 0) {
                container.innerHTML = `<div class="min-w-full text-center text-xs text-textGrey py-6 bg-white rounded-2xl border border-gray-100">لا توجد حصص مجدولة اليوم</div>`;
                return;
            }

            list.sort((a,b) => a.time.localeCompare(b.time));

            list.forEach(s => {
                const div = document.createElement('div');
                div.className = "min-w-[150px] bg-white rounded-2xl border border-gray-100 p-4 flex flex-col justify-between shadow-sm";
                div.onclick = () => openDetails(s.tId, s.gId, s.sId, s.teacher, s.subject); // clickable schedule
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-bold text-primaryBlack truncate max-w-[90px]">${s.subject}</span>
                        <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-full">قادم</span>
                    </div>
                    <p class="text-[10px] text-textGrey mb-1">${s.teacher}</p>
                    <p class="text-sm font-mono text-primaryBlack font-bold">${formatTime(s.time)}</p>
                `;
                container.appendChild(div);
            });
        }

        function formatTime(timeStr) {
            if(!timeStr) return '';
            let [h, m] = timeStr.split(':');
            h = parseInt(h);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m} ${ampm}`;
        }

        // --- DETAILS OVERLAY (Modal Logic) ---
        async function openDetails(tId, gId, sId, tName, subject) {
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');
            
            document.getElementById('modalTitle').innerText = subject;
            document.getElementById('modalSubtitle').innerText = `مع أ/ ${tName}`;
            content.innerHTML = '<div class="text-center py-10"><div class="w-8 h-8 border-4 border-brand rounded-full loader mx-auto"></div></div>';
            
            modal.classList.remove('translate-y-full');

            try {
                // Fetch Details Logic (Same as before)
                const attSnap = await db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`).orderBy('date', 'desc').limit(10).get();
                let attHtml = '';
                attSnap.forEach(d => {
                    const r = d.data().records?.find(x => x.studentId === sId);
                    if(r) {
                        let color = 'text-gray-400';
                        let icon = 'ri-question-mark';
                        let status = 'غير محدد';
                        if(r.status === 'present') { color='text-success'; icon='ri-check-double-line'; status='حاضر'; }
                        else if(r.status === 'absent') { color='text-red-500'; icon='ri-close-line'; status='غائب'; }
                        else if(r.status === 'late') { color='text-orange-500'; icon='ri-time-line'; status='تأخير'; }

                        attHtml += `
                        <div class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-gray-50">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-gray-50 rounded-lg flex items-center justify-center ${color}">
                                    <i class="${icon}"></i>
                                </div>
                                <span class="text-sm font-bold text-primaryBlack">${d.data().date}</span>
                            </div>
                            <span class="text-xs font-medium ${color}">${status}</span>
                        </div>`;
                    }
                });

                const gradeSnap = await db.collection(`teachers/${tId}/groups/${gId}/assignments`).limit(10).get();
                let gradeHtml = '';
                gradeSnap.forEach(d => {
                    const s = d.data().scores?.[sId];
                    if(s) {
                        gradeHtml += `
                        <div class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border-l-4 border-l-brand">
                            <div>
                                <p class="text-sm font-bold text-primaryBlack">${d.data().name}</p>
                                <span class="text-[10px] text-textGrey bg-gray-100 px-2 rounded">${d.data().type || 'واجب'}</span>
                            </div>
                            <span class="text-lg font-black text-primaryBlack">${s.score || '-'}</span>
                        </div>`;
                    }
                });

                content.innerHTML = `
                    <h4 class="text-sm font-bold text-textGrey mt-2 mb-2">سجل الحضور</h4>
                    <div class="space-y-2">${attHtml || '<p class="text-center text-xs text-gray-400">لا يوجد سجل</p>'}</div>
                    <h4 class="text-sm font-bold text-textGrey mt-6 mb-2">الدرجات والواجبات</h4>
                    <div class="space-y-2">${gradeHtml || '<p class="text-center text-xs text-gray-400">لا توجد درجات</p>'}</div>
                `;

            } catch(e) {
                content.innerHTML = '<p class="text-center text-red-500">حدث خطأ في تحميل التفاصيل</p>';
            }
        }

        function closeDetails() {
            document.getElementById('detailsModal').classList.add('translate-y-full');
        }

        async function requestPermission() {
            if(!messaging) return alert("غير مدعوم");
            try {
                const perm = await Notification.requestPermission();
                if(perm === 'granted') {
                    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    const token = await messaging.getToken({ vapidKey: "BN3l770-6tQOnDww8FXClGklZcfNUHzSWFUBMR-NN8Qupvfz_rdiZ0duLit7LMZjwjbhJu1SzJyI21pACl1WOVE", serviceWorkerRegistration: reg });
                    
                    if(currentParentPhone) {
                        await db.collection('parents').doc(currentParentPhone).set({ fcmToken: token }, { merge: true });
                        document.getElementById('notifyDot').classList.add('hidden');
                        alert("تم تفعيل الإشعارات بنجاح ✅");
                    }
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>