<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spot - ولي الأمر</title>
    
    <link rel="icon" href="assets/images/favicon.png" type="image/x-icon">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Inter:wght@400;600;700;900&family=Readex+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#F2CE5A', 
                        brand: '#F2CE5A',
                        darkBg: '#121212',       
                        darkCard: '#1E1E1E',     
                        lightBg: '#F3F4F6',
                        lightCard: '#FFFFFF',
                        borderDark: 'rgba(255,255,255,0.08)',
                    },
                    fontFamily: { 
                        cairo: ['Cairo', 'sans-serif'], 
                        readex: ['Readex Pro', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(242, 206, 90, 0.15)',
                        'floating': '0 8px 32px 0 rgba(0, 0, 0, 0.2)', 
                    },
                    animation: {
                        'fade-up': 'fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s infinite ease-in-out'
                    },
                    keyframes: {
                        fadeUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Readex Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Grid Background */
        .bg-grid-pattern {
            background-color: #F3F4F6;
            background-image: 
                linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .dark .bg-grid-pattern {
            background-color: #121212;
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Floating Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .dark .glass-header {
            background: rgba(30, 30, 30, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        /* Card Styling */
        .spot-card {
            border-radius: 20px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .spot-card:active { transform: scale(0.98); }

        .card-light { background: #FFFFFF; border: 1px solid #E5E7EB; }
        .dark .card-dark { background: #1E1E1E; border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }

        /* Tabs */
        .tab-btn { transition: all 0.3s; }
        .tab-btn.active { background-color: #F2CE5A; color: #000; font-weight: 700; box-shadow: 0 2px 10px rgba(242,206,90,0.3); }

        /* Inputs */
        .input-field { background: #FFFFFF; border: 1px solid #E5E7EB; color: #111827; }
        .dark .input-field { background: #1E1E1E; border: 1px solid rgba(255,255,255,0.1); color: white; }
        .input-field:focus { border-color: #F2CE5A; box-shadow: 0 0 0 2px rgba(242, 206, 90, 0.2); }

        .loader { border-top-color: #F2CE5A; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-grid-pattern text-gray-900 dark:text-white min-h-screen transition-colors duration-300 pb-10">

    <div id="loadingScreen" class="fixed inset-0 z-[100] bg-lightBg dark:bg-darkBg flex flex-col items-center justify-center hidden">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-gray-200 dark:border-gray-800 border-t-primary rounded-full loader"></div>
            <div class="absolute inset-0 flex items-center justify-center animate-pulse">
                <img src="assets/images/learnaria_logo.png" 
                     class="w-10 h-10 object-contain" 
                     onerror="this.src='assets/images/favicon.png'" 
                     alt="Loading...">
            </div>
        </div>
        <p class="mt-6 text-xs font-bold text-gray-400 tracking-widest uppercase font-mono">جاري التحميل...</p>
    </div>

    <header class="fixed top-4 left-4 right-4 z-50 glass-header rounded-2xl transition-all duration-300">
        <div class="px-5 py-3 flex justify-between items-center">
            
            <div class="flex items-center gap-3">
                <div class="relative w-11 h-11 rounded-xl bg-white border-2 border-primary flex items-center justify-center shadow-sm">
                    <img src="assets/images/learnaria_logo.png" class="w-7 h-7 object-contain" onerror="this.src='assets/images/favicon.png'">
                    
                    <div class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-green-500 rounded-full border-[3px] border-white dark:border-[#1E1E1E]"></div>
                </div>
                
                <div>
                    <h1 class="text-2xl font-black text-gray-900 dark:text-white font-inter tracking-tight">
                        Spot<span class="text-brand">.</span>
                    </h1>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-white/5 flex items-center justify-center transition text-gray-600 dark:text-gray-300 hover:text-primary hover:bg-gray-200 dark:hover:bg-white/10">
                    <i id="themeIcon" class="ri-moon-line text-lg"></i>
                </button>
                <button onclick="logout()" class="w-10 h-10 rounded-xl bg-red-50 dark:bg-red-500/10 text-red-500 flex items-center justify-center transition hover:bg-red-100 dark:hover:bg-red-500/20">
                    <i class="ri-logout-box-r-line text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-5 pt-32 max-w-lg">

        <div id="loginSection" class="hidden min-h-[60vh] flex flex-col items-center justify-center animate-fade-up">
            <div class="w-24 h-24 bg-white dark:bg-darkCard rounded-[2rem] shadow-floating flex items-center justify-center mb-8 border border-gray-100 dark:border-white/5 relative">
                <div class="absolute -right-2 -bottom-2 w-6 h-6 bg-green-500 rounded-full border-4 border-white dark:border-darkBg z-10"></div>
                <img src="assets/images/learnaria_logo.png" class="w-14 h-14 object-contain" onerror="this.src='assets/images/favicon.png'">
            </div>
            <h2 class="text-3xl font-black mb-2 text-center" style="font-family: 'Inter', sans-serif;">بوابة ولي الأمر</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-10 text-center px-6 leading-relaxed font-medium">
                أدخل رقم الهاتف لمتابعة التقارير الدراسية
            </p>
            
            <div class="w-full space-y-4">
                <div class="relative group">
                    <input type="tel" id="parentPhoneInput" placeholder="01xxxxxxxxx" 
                           class="w-full input-field rounded-2xl p-4 text-center text-xl font-bold outline-none transition-all placeholder-gray-400 dark:placeholder-gray-600 font-mono">
                    <i class="ri-smartphone-line absolute top-1/2 -translate-y-1/2 right-5 text-gray-400 text-xl group-focus-within:text-primary transition-colors"></i>
                </div>
                <button onclick="handleLogin()" class="w-full bg-primary hover:bg-yellow-400 text-black font-black py-4 rounded-2xl shadow-lg shadow-primary/20 active:scale-95 transition-all text-lg flex items-center justify-center gap-2">
                    <span>دخول</span>
                    <i class="ri-arrow-left-line"></i>
                </button>
            </div>
        </div>

        <div id="dashboardSection" class="hidden space-y-8 animate-fade-up">
            
            <div class="flex justify-between items-end px-1 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 tracking-wide">لوحة المتابعة</p>
                    <h2 id="headerGuardianText" class="text-2xl font-black leading-tight text-gray-900 dark:text-white" style="font-family: 'Cairo', sans-serif;">...</h2>
                </div>
            </div>

            <div onclick="requestPermission()" id="notifyBanner" class="hidden cursor-pointer relative group overflow-hidden rounded-[2rem] border border-primary/20 bg-darkCard/50 backdrop-blur-sm">
                <div class="absolute inset-0 bg-gradient-to-r from-primary/10 to-transparent"></div>
                <div class="relative p-5 flex items-center gap-5">
                    <div class="w-12 h-12 bg-primary text-black rounded-full flex items-center justify-center shadow-glow animate-pulse-slow">
                        <i class="ri-notification-3-fill text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white" style="font-family: 'Cairo', sans-serif;">تفعيل التنبيهات</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">ليصلك كل جديد عن الغياب والدرجات</p>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-lg mb-5 flex items-center gap-2 px-1 text-gray-900 dark:text-white" style="font-family: 'Cairo', sans-serif;">
                    <i class="ri-dashboard-fill text-primary"></i>
                    المواد الدراسية
                </h3>
                <div id="coursesList" class="space-y-5"></div>
            </div>
        </div>

        <div id="detailsModal" class="fixed inset-0 z-[60] pointer-events-none opacity-0 transition-opacity duration-300 flex items-end sm:items-center justify-center">
            
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeDetails()"></div>
            
            <div id="modalContainer" class="relative w-full max-w-lg h-[85vh] bg-lightBg dark:bg-darkBg rounded-t-[2.5rem] transform translate-y-full transition-transform duration-300 pointer-events-auto flex flex-col shadow-2xl overflow-hidden border-t border-white/10">
                
                <div class="px-6 py-6 bg-white dark:bg-darkCard border-b border-gray-100 dark:border-white/5 z-10">
                    <div class="w-12 h-1.5 bg-gray-200 dark:bg-white/10 rounded-full mx-auto mb-6"></div>
                    
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] font-bold bg-primary/10 text-primary px-2 py-0.5 rounded-lg border border-primary/20">المادة</span>
                            </div>
                            <h2 id="modalSubject" class="text-2xl font-black text-gray-900 dark:text-white leading-none" style="font-family: 'Cairo', sans-serif;">...</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 font-bold">معلم: <span id="modalTeacher" class="text-primary">...</span></p>
                        </div>
                        <button onclick="closeDetails()" class="w-10 h-10 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center text-gray-500 hover:text-red-500 dark:hover:bg-red-500/10 transition-colors">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>

                    <div class="flex bg-gray-100 dark:bg-black/30 p-1.5 rounded-2xl mt-8">
                        <button onclick="switchTab('home')" class="tab-btn active flex-1 py-3 text-xs font-bold rounded-xl" id="btn-home">ملخص</button>
                        <button onclick="switchTab('grades')" class="tab-btn flex-1 py-3 text-xs font-bold rounded-xl text-gray-500 dark:text-gray-400" id="btn-grades">الدرجات</button>
                        <button onclick="switchTab('payments')" class="tab-btn flex-1 py-3 text-xs font-bold rounded-xl text-gray-500 dark:text-gray-400" id="btn-payments">المصاريف</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-transparent custom-scroll">
                    
                    <div id="view-home" class="tab-content space-y-6 animate-fade-up">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="spot-card card-light dark:card-dark p-5 text-center">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold mb-2">نسبة الحضور</p>
                                <h3 id="modalAttPerc" class="text-3xl font-black text-gray-900 dark:text-white">--%</h3>
                            </div>
                            <div class="spot-card card-light dark:card-dark p-5 text-center">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold mb-2">آخر تقييم</p>
                                <h3 id="modalLastGrade" class="text-3xl font-black text-primary">--</h3>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xs font-bold text-gray-400 mb-4 flex items-center gap-2">
                                <i class="ri-history-line text-primary"></i> النشاط الأخير
                            </h3>
                            <div id="modalAttendanceList" class="space-y-0 relative border-r-2 border-gray-200 dark:border-white/5 mr-2 pr-5 pb-2"></div>
                        </div>
                    </div>

                    <div id="view-grades" class="tab-content hidden space-y-4 animate-fade-up">
                        <div id="modalGradesList" class="space-y-3"></div>
                    </div>

                    <div id="view-payments" class="tab-content hidden space-y-5 animate-fade-up">
                        <div id="paymentStatusBanner" class="spot-card card-light dark:card-dark p-6 flex items-center justify-between border-r-4">
                            <div>
                                <p class="text-sm font-bold text-gray-900 dark:text-white">الشهر الحالي</p>
                                <p class="text-xs text-gray-500 mt-1" id="currentMonthName">...</p>
                            </div>
                            <span id="currentMonthStatus" class="px-4 py-2 rounded-xl text-xs font-bold">--</span>
                        </div>
                        <h3 class="text-xs font-bold text-gray-400 mt-6 mb-3 flex items-center gap-2">
                            <i class="ri-wallet-3-fill text-primary"></i> السجل المالي
                        </h3>
                        <div id="modalPaymentsList" class="space-y-3"></div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbN4awHvNUZWC-uCgU_hR7iYiHk-3dpv8",
            authDomain: "learnaria-483e7.firebaseapp.com",
            projectId: "learnaria-483e7",
            storageBucket: "learnaria-483e7.firebasestorage.app",
            messagingSenderId: "573038013067",
            appId: "1:573038013067:web:db6a78e8370d33b07a828e"
        };
        
        let db, messaging;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            if (firebase.messaging.isSupported()) messaging = firebase.messaging();
        } catch (e) { console.error(e); }

        let currentParentPhone = "";

        // --- INIT & THEME ---
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage))) {
            document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').className = 'ri-sun-line text-lg';
        } else {
            document.documentElement.classList.remove('dark');
            document.getElementById('themeIcon').className = 'ri-moon-line text-lg';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const urlPhone = urlParams.get('p');

        if (urlPhone) {
            currentParentPhone = urlPhone;
            loadApp();
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
        }

        // --- FUNCTIONS ---
        function handleLogin() {
            const phone = document.getElementById('parentPhoneInput').value.trim();
            if (phone.length < 10) return alert("رقم غير صحيح");
            currentParentPhone = phone;
            document.getElementById('loginSection').classList.add('hidden');
            loadApp();
        }

        function logout() { window.location.href = window.location.pathname; }

        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark'); localStorage.setItem('theme', 'light');
                document.getElementById('themeIcon').className = 'ri-moon-line text-lg';
            } else {
                html.classList.add('dark'); localStorage.setItem('theme', 'dark');
                document.getElementById('themeIcon').className = 'ri-sun-line text-lg';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            const btn = document.getElementById(`btn-${tab}`);
            if(btn) {
                btn.classList.add('active');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            }
        }

        async function loadApp() {
            document.getElementById('loadingScreen').classList.remove('hidden');
            try {
                const snapshot = await db.collectionGroup('students').where('parentPhoneNumber', '==', currentParentPhone).get();
                if (snapshot.empty) { alert("لم يتم العثور على بيانات"); location.reload(); return; }

                document.getElementById('dashboardSection').classList.remove('hidden');
                
                let studentNames = new Set();
                let listHtml = '';

                for (const doc of snapshot.docs) {
                    const sData = doc.data();
                    studentNames.add(sData.name.split(' ')[0]);
                    const path = doc.ref.path.split('/');
                    const tId = path[1], gId = path[3], sId = doc.id;

                    let tName = "مدرس", subName = "مادة";
                    const tDoc = await db.collection('teachers').doc(tId).get();
                    if(tDoc.exists) { tName = tDoc.data().name; subName = tDoc.data().subject || "عام"; }

                    // Stats
                    const attSnap = await db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`).limit(20).get();
                    let totalDays=0, presentDays=0;
                    attSnap.forEach(d => {
                        const r = d.data().records?.find(x => x.studentId === sId);
                        if(r) { totalDays++; if(r.status==='present') presentDays++; }
                    });
                    const attPerc = totalDays > 0 ? Math.round((presentDays/totalDays)*100) : 0;

                    const assSnap = await db.collection(`teachers/${tId}/groups/${gId}/assignments`).orderBy('date', 'desc').limit(1).get();
                    let lastGrade = '--';
                    if(!assSnap.empty) {
                        const score = assSnap.docs[0].data().scores?.[sId];
                        if(score) lastGrade = score.score || (score.submitted ? '✅' : '❌');
                    }

                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const payDoc = await db.collection(`teachers/${tId}/groups/${gId}/payments`).doc(`${gId}_PAY_${currentMonth}`).get();
                    let isPaid = false;
                    if(payDoc.exists) {
                        const r = payDoc.data().records?.find(x => x.studentId === sId);
                        if(r && r.paid) isPaid = true;
                    }

                    listHtml += `
                    <div class="spot-card card-light dark:card-dark p-5 cursor-pointer group relative overflow-hidden" onclick="openDetails('${tId}', '${gId}', '${sId}', '${tName}', '${subName}')">
                        <div class="absolute -right-5 -top-5 w-24 h-24 bg-primary/5 rounded-full blur-xl group-hover:bg-primary/10 transition"></div>
                        
                        <div class="flex justify-between items-start mb-5 relative z-10">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-2xl bg-gray-50 dark:bg-black border border-gray-200 dark:border-white/5 flex items-center justify-center shadow-inner">
                                    <span class="text-2xl font-black text-primary">${subName.charAt(0)}</span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-black text-gray-900 dark:text-white leading-tight mb-1" style="font-family: 'Cairo', sans-serif;">${subName}</h3>
                                    <div class="flex items-center gap-2">
                                        <i class="ri-user-line text-xs text-primary"></i>
                                        <p class="text-xs text-gray-500 font-bold">${tName}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="text-[10px] bg-gray-100 dark:bg-white/5 text-gray-500 px-2 py-0.5 rounded-md font-bold">${sData.name.split(' ')[0]}</span>
                                ${isPaid 
                                    ? '<span class="text-[10px] text-green-500 bg-green-500/10 px-2 py-0.5 rounded-md font-bold border border-green-500/20">مدفوع</span>' 
                                    : '<span class="text-[10px] text-red-500 bg-red-500/10 px-2 py-0.5 rounded-md font-bold border border-red-500/20">غير مدفوع</span>'}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-2 border-t border-gray-100 dark:border-white/5 pt-3">
                            <div><p class="text-[10px] text-gray-400 font-bold">نسبة الحضور</p><p class="text-lg font-black ${attPerc>85?'text-green-500':'text-primary'}">${attPerc}%</p></div>
                            <div><p class="text-[10px] text-gray-400 font-bold">آخر تقييم</p><p class="text-lg font-black text-gray-900 dark:text-white">${lastGrade}</p></div>
                        </div>
                    </div>`;
                }

                if(studentNames.size > 0) document.getElementById('headerGuardianText').innerHTML = `ولي أمر الطالب <span class="text-primary">${Array.from(studentNames).join('، ')}</span>`;
                document.getElementById('coursesList').innerHTML = listHtml;
                if(Notification.permission !== 'granted') document.getElementById('notifyBanner').classList.remove('hidden');

            } catch (e) { console.error(e); } 
            finally { document.getElementById('loadingScreen').classList.add('hidden'); }
        }

        async function openDetails(tId, gId, sId, tName, subject) {
            document.getElementById('modalSubject').innerText = subject;
            document.getElementById('modalTeacher').innerText = tName;
            const modal = document.getElementById('detailsModal');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            cont.classList.remove('translate-y-full');

            const loader = '<div class="flex justify-center py-10"><div class="loader w-8 h-8 border-4 border-gray-700 border-t-primary rounded-full"></div></div>';
            const attList = document.getElementById('modalAttendanceList');
            const grList = document.getElementById('modalGradesList');
            const payList = document.getElementById('modalPaymentsList');
            
            if(attList) attList.innerHTML = loader;
            if(grList) grList.innerHTML = '';
            if(payList) payList.innerHTML = '';
            
            switchTab('home');

            try {
                // A. Attendance
                const attSnap = await db.collection(`teachers/${tId}/groups/${gId}/dailyAttendance`).orderBy('date', 'desc').limit(20).get();
                let attHtml = '', total=0, present=0;
                attSnap.forEach(d => {
                    const r = d.data().records?.find(x => x.studentId === sId);
                    if(r) {
                        total++; if(r.status==='present') present++;
                        let col = r.status==='present'?'bg-green-500':(r.status==='absent'?'bg-red-500':'bg-yellow-500');
                        let txt = r.status==='present'?'حاضر':(r.status==='absent'?'غائب':'تأخير');
                        let txtCol = r.status==='present'?'text-green-500':(r.status==='absent'?'text-red-500':'text-yellow-500');
                        attHtml += `<div class="relative pl-6 pb-8 last:pb-0 border-l-2 border-gray-200 dark:border-white/10 last:border-0"><div class="absolute -right-[7px] top-0 w-3.5 h-3.5 rounded-full ${col} ring-4 ring-white dark:ring-darkBg z-10"></div><div class="flex justify-between items-center bg-white dark:bg-white/5 p-3 rounded-xl border border-gray-100 dark:border-white/5"><span class="text-sm font-bold text-gray-800 dark:text-gray-200">${d.data().date}</span><span class="text-xs font-bold px-2 py-0.5 rounded bg-black/5 dark:bg-white/10 ${txtCol}">${txt}</span></div></div>`;
                    }
                });
                if(attList) attList.innerHTML = attHtml || '<p class="text-center text-gray-500">لا يوجد سجل</p>';
                document.getElementById('modalAttPerc').innerText = total>0 ? Math.round((present/total)*100)+'%' : '0%';

                // B. Grades
                const grSnap = await db.collection(`teachers/${tId}/groups/${gId}/assignments`).limit(20).orderBy('date', 'desc').get();
                let grHtml = '', lastG='--';
                if(!grSnap.empty) {
                    grSnap.forEach((doc, idx) => {
                        const d = doc.data();
                        const s = d.scores?.[sId];
                        let scoreDisp='--', stCol='border-gray-500', stTxt='لم يسلم', stBg='bg-gray-500/10 text-gray-500';
                        if(s) {
                            if(s.score) { scoreDisp=s.score; stCol='border-primary'; stTxt='تم الرصد'; stBg='bg-primary/10 text-primary'; if(idx===0) lastG=s.score; }
                            else if(s.submitted) { scoreDisp='<i class="ri-check-line"></i>'; stCol='border-green-500'; stTxt='تم التسليم'; stBg='bg-green-500/10 text-green-500'; }
                            else { stCol='border-red-500'; stTxt='غائب'; stBg='bg-red-500/10 text-red-500'; }
                        } else { stCol='border-red-500'; stTxt='لم يسلم'; stBg='bg-red-500/10 text-red-500'; }

                        grHtml += `<div class="spot-card card-light dark:card-dark p-4 flex justify-between items-center border-l-4 ${stCol}"><div><h4 class="font-bold text-sm text-gray-900 dark:text-white mb-1">${d.name}</h4><span class="text-[10px] ${stBg} px-2 py-0.5 rounded font-bold">${stTxt}</span></div><div class="text-center min-w-[50px]"><span class="block text-xl font-black text-gray-900 dark:text-white">${scoreDisp}</span><span class="text-[9px] text-gray-400">الدرجة</span></div></div>`;
                    });
                }
                if(grList) grList.innerHTML = grHtml || '<p class="text-center text-gray-500">لا توجد درجات</p>';
                document.getElementById('modalLastGrade').innerText = lastG;

                // C. Payments
                const paySnap = await db.collection(`teachers/${tId}/groups/${gId}/payments`).limit(12).get();
                let payHtml = '';
                const currM = new Date().toISOString().slice(0, 7);
                let currStatus = 'غير مدفوع', currClass = 'bg-red-500 border-red-500 text-white';

                paySnap.forEach(d => {
                    const m = d.data().month;
                    const r = d.data().records?.find(x => x.studentId === sId);
                    const p = r && r.paid;
                    if(m===currM) { 
                        if(p) { currStatus='تم الدفع ✅'; currClass='bg-green-500 border-green-500 text-white'; }
                        else { currStatus='مطلوب سداد ⚠️'; currClass='bg-red-500 border-red-500 text-white'; }
                    }
                    payHtml += `<div class="flex justify-between items-center p-4 rounded-xl bg-white dark:bg-white/5 border border-gray-100 dark:border-white/5 mb-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${p?'bg-green-500/20 text-green-500':'bg-red-500/20 text-red-500'} flex items-center justify-center"><i class="${p?'ri-checkbox-circle-fill':'ri-close-circle-fill'} text-lg"></i></div><span class="font-bold text-sm text-gray-800 dark:text-gray-200">${m}</span></div><span class="text-xs font-bold ${p?'text-green-500':'text-red-500'}">${p?(r.amount+' ج.م'):'غير مدفوع'}</span></div>`;
                });
                if(payList) payList.innerHTML = payHtml;
                document.getElementById('currentMonthName').innerText = currM;
                const statusBadge = document.getElementById('currentMonthStatus');
                statusBadge.innerText = currStatus;
                statusBadge.className = `px-3 py-1.5 rounded-lg text-xs font-bold border ${currClass}`;
                document.getElementById('paymentStatusBanner').className = `spot-card card-light dark:card-dark p-6 flex items-center justify-between border-r-4 ${currStatus.includes('الدفع')?'border-green-500':'border-red-500'}`;

            } catch(e) { console.error(e); }
        }

        function closeDetails() {
            document.getElementById('modalContainer').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('detailsModal').classList.add('opacity-0', 'pointer-events-none'), 300);
        }

        async function requestPermission() {
            if(!messaging) return alert("غير مدعوم");
            try {
                if((await Notification.requestPermission()) === 'granted') {
                    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    const token = await messaging.getToken({ vapidKey: "BN3l770-6tQOnDww8FXClGklZcfNUHzSWFUBMR-NN8Qupvfz_rdiZ0duLit7LMZjwjbhJu1SzJyI21pACl1WOVE", serviceWorkerRegistration: reg });
                    if(currentParentPhone) {
                        await db.collection('parents').doc(currentParentPhone).set({ fcmToken: token }, { merge: true });
                        document.getElementById('notifyBanner').classList.add('hidden');
                        alert("تم التفعيل بنجاح ✅");
                    }
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>