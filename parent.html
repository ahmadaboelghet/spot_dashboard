<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spot - Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" href="./favicon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spot">
    <meta name="theme-color" content="#fbbf24">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        .app-icon { box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.5); }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-gray-100">
        <div class="w-24 h-24 bg-yellow-400 rounded-2xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg app-icon text-white transform hover:scale-105 transition-transform duration-300">
            ğŸ””
        </div>
        
        <h1 class="text-2xl font-bold mb-2 text-gray-800">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>
        <p class="text-gray-500 mb-8 text-sm leading-relaxed">
            Ø§Ø¶ØºØ· ØªÙØ¹ÙŠÙ„ Ù„ØªØµÙ„Ùƒ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨ <br>
            <span id="studentName" class="font-bold text-black text-lg bg-yellow-50 px-2 py-1 rounded mt-1 inline-block">...</span>
            <br> ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ.
        </p>

        <button id="allowBtn" onclick="requestPermission()" class="w-full bg-black text-white font-bold py-4 rounded-xl shadow-xl hover:bg-gray-800 active:scale-95 transition-all duration-200 text-lg flex items-center justify-center gap-2">
            <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¢Ù†</span>
            <i class="ri-notification-3-line"></i>
        </button>
        
        <p id="statusMsg" class="mt-6 text-xs font-bold text-gray-400 hidden"></p>
        
        <div class="mt-8 pt-6 border-t border-gray-100 text-center">
            <p class="text-[10px] text-gray-400">Spot - Smart Education System</p>
        </div>
    </div>

    <script>
        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAbN4awHvNUZWC-uCgU_hR7iYiHk-3dpv8",
            authDomain: "learnaria-483e7.firebaseapp.com",
            projectId: "learnaria-483e7",
            storageBucket: "learnaria-483e7.firebasestorage.app",
            messagingSenderId: "573038013067",
            appId: "1:573038013067:web:db6a78e8370d33b07a828e"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const messaging = firebase.messaging();
        const db = firebase.firestore();

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø· (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© +)
        const urlParams = new URLSearchParams(window.location.search);
        let tId = urlParams.get('t');
        // ØªØµØ­ÙŠØ­ Ø°ÙƒÙŠ: Ù„Ùˆ Ø§Ù„Ø±Ù‚Ù… ÙÙŠÙ‡ Ù…Ø³Ø§ÙØ© Ø¨Ø¯Ù„ + Ù†ØµÙ„Ø­Ù‡Ø§
        if (tId && tId.includes(' ') && !tId.includes('+')) {
            tId = tId.replace(/ /g, '+');
        }

        const gId = urlParams.get('g'); 
        const sId = urlParams.get('s'); 
        const name = urlParams.get('n'); 

        if(name) document.getElementById('studentName').innerText = decodeURIComponent(name);

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        async function requestPermission() {
            const btn = document.getElementById('allowBtn');
            const status = document.getElementById('statusMsg');
            
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>`;

            try {
                // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
                    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
                    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    // Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ ØªØ­Øª Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø·ÙˆÙŠÙ„ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¨Ø¯Ø£ Ø¨Ù€ B
                    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    const token = await messaging.getToken({ 
                        vapidKey: "BN3l770-6tQOnDww8FXClGklZcfNUHzSWFUBMR-NN8Qupvfz_rdiZ0duLit7LMZjwjbhJu1SzJyI21pACl1WOVE", 
                        serviceWorkerRegistration: registration 
                    });
                    
                    if(token && tId && gId && sId) {
                        // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† (Ø§Ø³ØªØ®Ø¯Ø§Ù… set merge Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙÙ‚ÙˆØ¯)
                        await db.doc(`teachers/${tId}/groups/${gId}/students/${sId}`).set({
                            parentFcmToken: token
                        }, { merge: true });

                        // Ù†Ø¬Ø§Ø­
                        btn.style.backgroundColor = "#22c55e"; // Green
                        btn.innerText = "ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
                        
                        // Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù„Ø£ÙŠÙÙˆÙ†
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                        if (isIOS && !window.navigator.standalone) {
                            status.innerText = "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.";
                        } else {
                            status.innerText = "Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø§Ù„Ø¢Ù†...";
                        }
                        
                        status.classList.remove('hidden', 'text-red-500');
                        status.classList.add('text-green-600');

                    } else {
                        throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©");
                    }
                } else {
                    throw new Error("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­");
                }
            } catch (error) {
                console.error("Error:", error);
                btn.style.backgroundColor = "#ef4444"; // Red
                btn.innerText = "ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„";
                
                if(error.code === 'messaging/token-subscribe-failed' || error.message.includes('registration')) {
                     status.innerText = "ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Chrome Ø£Ùˆ Safari.";
                } else {
                     status.innerText = "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù‚ÙÙ„ ğŸ”’ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ¹Ù…Ù„ Reset Permissions.";
                }
                
                status.classList.remove('hidden');
                status.classList.add('text-red-500');
                btn.disabled = false;
            }
        }

        // 4. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© (Foreground)
        messaging.onMessage((payload) => {
            console.log('Message received. ', payload);
            const notificationTitle = payload.notification.title;
            const notificationOptions = {
                body: payload.notification.body,
                icon: './favicon.png'
            };

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
            if (Notification.permission === "granted") {
                new Notification(notificationTitle, notificationOptions);
            } else {
                // Ø¨Ø¯ÙŠÙ„ Ù„Ùˆ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ù…Ù†ÙˆØ¹: Alert
                alert(`ğŸ”” ${notificationTitle}\n${notificationOptions.body}`);
            }
        });
    </script>
</body>
</html>